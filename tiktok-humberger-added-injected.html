<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Analytics &amp; Growth Dashboard</title>
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/odometer@0.4.8/themes/odometer-theme-default.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/odometer@0.4.8/odometer.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        :root {
            --bg-main: #F7F8FC;
            --bg-card: #FFFFFF;
            --text-primary: #1A202C;
            --text-secondary: #64748B;
            --border-color: #E2E8F0;
            --tiktok-pink: #FE2C55;
            --tiktok-cyan: #25F4EE;
            --tiktok-pink-hover: #E4274C;
            --winner-gold: #FBBF24;
            --winner-gold-bg: rgba(251, 191, 36, 0.1);
            --header-accent-gradient: linear-gradient(135deg, var(--tiktok-cyan), var(--tiktok-pink));
        }

        html { scroll-behavior: smooth; }

        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* --- Header / Navigation --- */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--bg-card);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            margin-bottom: 2rem;
        }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 700; }
        .logo .fa-tiktok { color: var(--tiktok-pink); }
        .nav-actions { display: flex; align-items: center; gap: 1rem; }
        .search-group { display: flex; align-items: center; }
        
        .input-with-icon-wrapper { position: relative; display: flex; align-items: center; flex-grow: 1; }
        .input-icon { position: absolute; left: 1rem; color: var(--tiktok-pink); font-size: 1.1rem; pointer-events: none; z-index: 20; }
        .search-input { width: 100%; min-width: 200px; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--border-color); border-right: none; border-radius: 0 0 0 0; background-color: #F8F9FA; font-size: 0.9rem; transition: box-shadow 0.2s; }
        .search-input:focus { outline: none; box-shadow: 0 0 0 2px var(--tiktok-pink); z-index: 10; }
        .search-btn { background-color: var(--tiktok-pink); color: white; border: none; padding: 0.75rem 1.25rem; border-radius: 0 0.5rem 0.5rem 0; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease; height: 100%; }
        .search-btn:hover { background-color: var(--tiktok-pink-hover); }
        .download-btn { background-color: #EDF2F7; color: #4A5568; border: 1px solid var(--border-color); padding: 0.65rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; }
        .download-btn:hover { background-color: #E2E8F0; border-color: #CBD5E0; }

        /* --- Content Layout --- */
        .content-area { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 1024px) { .content-area { grid-template-columns: 2fr 1fr; } }
        
        #result {
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); }

        /* --- Profile & Metrics --- */
        .profile-header-card { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; text-align: center;border-bottom: 4px solid var(--tiktok-pink); }
        @media (min-width: 640px) { .profile-header-card { flex-direction: row; text-align: left; } }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--tiktok-pink); object-fit: cover; flex-shrink: 0; }
        .profile-info { flex-grow: 1; }
        .profile-name { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
        .profile-username { color: var(--text-secondary); }
        .profile-bio { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.75rem; }

        /* --- Creator Credibility System (Badge/Title/Stars) --- */
        .creator-tier-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            padding: 0 1rem;
            min-width: 160px;
            flex-shrink: 0;
            border-left: 1px solid var(--border-color);
            margin-top: 1rem;
            padding-left: 2rem;
        }
        @media (max-width: 639px) {
            .creator-tier-display { border-left: none; padding-left: 0; margin-top: 1.5rem; }
        }
        .tier-badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background-color: var(--bg-card);
            border: 3px solid var(--tiktok-cyan);
            box-shadow: 0 0 0px rgba(254, 44, 85, 0.7);
            transition: all 0.3s ease;
        }
        
       @keyframes tier-badge-pulse {
          0% { box-shadow: 0 0 0 0 rgba(254, 44, 85, 0.7); }
          70% { box-shadow: 0 0 0 10px rgba(254, 44, 85, 0); }
          100% { box-shadow: 0 0 0 0 rgba(254, 44, 85, 0); }
        }
        .is-pulsing { animation: tier-badge-pulse 2s infinite; }
        .tier-badge-score { font-size: 1.5rem; font-weight: 800; line-height: 1; color: #222222; }
        .tier-title { font-size: 1.1rem; font-weight: 700; margin-top: 0.75rem; color: #222222; }
        .tier-description { font-size: 0.8rem; color: #ccc; margin-top: 0.2rem; }
        .tier-stars { font-size: 1rem; color: var(--winner-gold); margin-top: 0.5rem; display: flex; gap: 0.2rem; }
        .tier-stars .fa-star-half-alt { color: var(--winner-gold); }
        .tier-stars .far.fa-star { color: #CBD5E0; }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        @media (min-width: 768px) { .metrics-grid { grid-template-columns: repeat(4, 1fr); } }
        .metric-item { display: flex; align-items: center; gap: 0.75rem; }
        .metric-icon { font-size: 1.25rem; width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; flex-shrink: 0; color: var(--tiktok-pink); background-color: rgba(254, 44, 85, 0.1); }
        .metric-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
        .metric-label { font-size: 0.8rem; color: var(--text-secondary); }

        /* --- Earnings & Growth Cards --- */
        .earnings-card { text-align: center; background-color: var(--text-primary); }
        .earnings-card .card-title, .earnings-card .earnings-note, .earnings-card .odometer { color: white; }
        .earnings-card .card-title { justify-content: center; opacity: 0.9;}
        .earnings-value { font-size: 3rem; font-weight: 800; line-height: 1; margin: 1rem 0; color: white; }
        .earnings-note { opacity: 0.7; }

        /* --- Right Column Cards --- */
        .insight-item, .breakdown-item { display: flex; justify-content: space-between; align-items: center; padding: 0.85rem 0; font-size: 0.9rem; }
        .insight-item:not(:last-child), .breakdown-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .item-label { color: var(--text-secondary); }
        .item-value { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .ratio-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 0.5rem; }
        
        /* --- Tooltip System --- */
        .tooltip { position: relative; cursor: help; display: inline-flex; align-items: center;}
        .tooltip-icon { color: #CBD5E0; margin-left: 0.5rem; font-size: 0.9em; vertical-align: middle; }
        .tooltip-text { visibility: hidden; width: 220px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 100; bottom: 130%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; font-weight: normal; line-height: 1.4; }
        .tooltip-text ul { list-style: none; padding: 0; margin: 0; }
        .tooltip-text li { margin-bottom: 4px; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* --- Calculator --- */
        .calculator-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); }
        .form-input { width: 100%; padding: 0.65rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 0.9rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus { outline: none; border-color: var(--tiktok-pink); box-shadow: 0 0 0 1px var(--tiktok-pink); }
        .total-breakdown { background: #fe2c55; color: white; padding: 0.75rem; border-bottom: 4px solid #333333;border-radius: 0.5rem; margin-top: 0.5rem; }
        .total-breakdown .item-label, .total-breakdown .item-value { color: white; }
        .total-breakdown .odometer { font-size: 1.25rem; font-weight: 700; display: inline-block; }
        
        /* --- Tabs Section --- */
        .tab-nav { border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; }
        .tab-btn { padding: 0.5rem 1rem; margin-bottom: -1px; border: none; background: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s ease; }
        .tab-btn.active-tab { color: var(--tiktok-pink); border-bottom-color: var(--tiktok-pink); }
        .tab-panel { display: none; padding: 1.5rem; }
        .tab-panel.active-panel { display: block; animation: fadeIn 0.5s ease-in-out; }
        .tab-content ul { list-style-position: inside; }
        .tab-content ul.recommendation-list li { margin-bottom: 0.75rem; display: flex; align-items: flex-start; gap: 0.75rem; }
        .tab-content ul.recommendation-list .fa-check-circle { color: #10B981; margin-top: 4px; }
        .tab-content ul.recommendation-list .fa-lightbulb { color: var(--winner-gold); margin-top: 4px; }
        .tab-content ul.recommendation-list .fa-exclamation-triangle { color: #EF4444; margin-top: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Loading/Error States --- */
        .message-section { text-align: center; padding: 4rem 2rem; }
        .spinner { width: 50px; height: 50px; border: 4px solid #E2E8F0; border-top-color: var(--tiktok-pink); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- Redesigned Single Post Analyzer --- */
        .post-video-details-bar {
            background-color: var(--text-primary);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }
        .post-video-details-bar .detail-item { display: flex; align-items: center; gap: 0.5rem; }
        .post-video-details-bar .detail-item i { color: var(--tiktok-pink); }
        
        .post-advanced-metric-grid-new {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .advanced-metric-item-new {
            background-color: #F8F9FA;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .advanced-metric-item-new .icon { color: var(--tiktok-pink); font-size: 1.2rem; width: 24px; text-align: center; flex-shrink: 0; }
        .advanced-metric-item-new .label { font-weight: 500; color: var(--text-secondary); flex-grow: 1; font-size: 0.9rem; }
        .advanced-metric-item-new .value-container { display: flex; align-items: baseline; gap: 0.5rem; }
        .advanced-metric-item-new .value { font-weight: 700; color: var(--text-primary); font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .advanced-metric-item-new .delta { font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
        .advanced-metric-item-new .delta-positive { color: #10B981; }
        .advanced-metric-item-new .delta-negative { color: #EF4444; }
        
        .post-earnings-display {
            background-color: var(--text-primary);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .post-earnings-label { font-size: 1rem; opacity: 0.8; margin-bottom: 0.5rem; display: block; }
        .post-earnings-value { font-size: 2.75rem; font-weight: 800; line-height: 1; display: flex; align-items: center; justify-content: center; gap: 0.25rem; }
        .post-earnings-value .odometer { font-size: 2.75rem; font-weight: 800; line-height: 1; }

        .optimization-tips-btn {
            display: inline-flex;
            background-color: var(--tiktok-pink);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
        }
        .optimization-tips-btn i { font-size: 1.1em; }
        .optimization-tips-btn:hover { background-color: var(--tiktok-pink-hover); transform: translateY(-2px); }
        #optimize-issues-container { text-align: center; margin-bottom: 1.5rem; }

        .post-optimization-checklist {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            animation: fadeIn 0.5s ease;
        }
        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #F8F9FA;
            border-left-width: 4px;
        }
        .checklist-item.status-good { border-color: #10B981; }
        .checklist-item.status-warning { border-color: #F59E0B; }
        .checklist-item.status-danger { border-color: #EF4444; }
        .checklist-item.status-info { border-color: #3B82F6; }

        .checklist-item .icon { font-size: 1.25rem; margin-top: 0.125rem; }
        .checklist-item.status-good .icon { color: #10B981; }
        .checklist-item.status-warning .icon { color: #F59E0B; }
        .checklist-item.status-danger .icon { color: #EF4444; }
        .checklist-item.status-info .icon { color: #3B82F6; }
        
        .checklist-item .text-content .title { font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem; }
        .checklist-item .text-content .description { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; }

        .post-analyzer-loading-bar {
            height: 8px;
            background-color: var(--border-color);
            border-radius: 99px;
            overflow: hidden;
            width: 100%;
            margin: 0.5rem 0;
        }
        .post-analyzer-loading-bar-fill {
            height: 100%;
            background-color: var(--tiktok-pink);
            width: 0%;
            border-radius: 99px;
            transition: width 5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* --- CTA Button --- */
        .cta-btn {
            background-image: linear-gradient(to right, var(--tiktok-cyan), var(--tiktok-pink));
            color: white; border: none; padding: 0.75rem 2rem; border-radius: 9999px; font-weight: 700;
            cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; display: inline-block;
            margin-top: 0.75rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .cta-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(254, 44, 85, 0.3); }

        /* --- Enhanced Comparison Styles --- */
        .comparison-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: flex-end; }
        .comparison-header-redesigned {
            background-color: var(--bg-card);
            padding: 2.5rem; /* Increased top padding */
            padding-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            border-radius: 1.5rem 1.5rem 0 0;
        }
        .header-separator { width: 1px; background-color: var(--border-color); align-self: stretch; height: auto; margin: -2.5rem 0; }
        .header-user-profile-new { display: flex; align-items: center; gap: 1.25rem; width: 45%; }
        .header-avatar-new { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; border: 4px solid var(--bg-main); box-shadow: 0 4px 10px rgba(0,0,0,0.08); flex-shrink: 0; }
        .header-user-info { text-align: left; }
        .header-nickname-new { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
        .header-username-new { font-size: 1rem; color: var(--text-secondary); }
        .header-stars { font-size: 0.9rem; color: var(--winner-gold); margin: 0.35rem 0; display: flex; gap: 0.15rem; }
        .header-stars .far.fa-star { color: #d1d5db; }
        .header-score-badge { background: none; padding: 0; text-align: right; margin-left: auto; }
        .header-score-badge .score-value { font-size: 1.75rem; font-weight: 800; color: #ccc; }
        .header-score-badge .score-label { font-size: 0.8rem; font-weight: 500; color: #ccc; text-transform: uppercase; letter-spacing: 0.5px; }
        .header-user-profile-new.user-2 { flex-direction: row-reverse; }
        .header-user-profile-new.user-2 .header-user-info { text-align: left; }
        .header-user-profile-new.user-2 .header-stars { justify-content: flex-end; }
        .header-user-profile-new.user-2 .header-score-badge { margin-right: auto; text-align: left; }

        .comparison-popup-body { padding: 2rem 2.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        #comparison-ai-summary { background-color: white; border-left: 4px solid var(--tiktok-cyan); padding: 1.25rem; border-radius: 0.5rem; }
        #comparison-ai-summary p { line-height: 1.6; color: var(--text-secondary); }
        #comparison-ai-summary strong { color: var(--text-primary); }
        .comparison-table-wrapper { overflow-x: auto; }
        .comparison-table { width: 100%; border-collapse: collapse; background-color: white; border-radius: 1rem; }
        .comparison-table th, .comparison-table td { padding: 1rem; text-align: center; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .comparison-table th { font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .comparison-table td:first-child { text-align: left; font-weight: 600; color: var(--text-primary); }
        .comparison-table tr:last-child td { border-bottom: none; }
        .metric-title-cell { display: flex; align-items: center; gap: 0.5rem; position: relative; }
        .comparison-value { font-weight: 700; font-size: 1.1rem; }
        .winner-cell { background-color: var(--winner-gold-bg); }
        .winner-icon { color: var(--winner-gold); margin-left: 0.5rem; font-size: 1.2rem; }
        .delta-value { font-weight: 700; font-size: 0.9rem; }
        .delta-positive { color: #10B981; }
        .delta-negative { color: #EF4444; }
        .tips-tab-container { background-color: white; border-radius: 1rem; padding: 1.75rem; }
        .tips-tab-container h4 { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;}
        .tips-tab-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .tips-tab-btn { padding: 0.5rem 1rem; margin-bottom: -1px; border: none; background: none; cursor: pointer; color: var(--text-secondary); font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s ease; font-size: 0.9rem; }
        .tips-tab-btn.active-tab { color: var(--tiktok-pink); border-bottom-color: var(--tiktok-pink); }
        .tips-tab-panel { display: none; }
        .tips-tab-panel.active-panel { display: block; animation: fadeIn 0.4s; }
        .tips-tab-container ul { list-style: none; padding-left: 0; }
        .tips-tab-container li { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; display: flex; gap: 0.75rem; align-items: flex-start; margin-bottom: 0.75rem;}
        .tips-tab-container li i { color: var(--winner-gold); margin-top: 5px; }


        /* --- Magic Nav Panel --- */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(254, 44, 85, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(254, 44, 85, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(254, 44, 85, 0); }
        }
        .magic-nav-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-image: linear-gradient(45deg, var(--tiktok-cyan), var(--tiktok-pink));
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
            animation: pulse 2s infinite;
            z-index: 999;
        }
        .magic-nav-button:hover { transform: scale(1.1); animation-play-state: paused; }
        .magic-side-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 280px;
            height: 100%;
            background-color: var(--bg-card);
            box-shadow: -5px 0 25px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1001;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        .magic-side-panel.open { transform: translateX(0); }
        .magic-panel-close {
            position: absolute; top: 1rem; right: 1rem;
            background: none; border: none; font-size: 1.75rem;
            color: var(--text-secondary); cursor: pointer; transition: color 0.2s;
        }
        .magic-panel-close:hover { color: var(--text-primary); }
        .magic-panel-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: var(--text-primary); }
        .magic-panel-nav { display: flex; flex-direction: column; gap: 0.5rem; }
        .magic-nav-item {
            color: var(--text-secondary); text-decoration: none; padding: 0.75rem 1rem;
            border-radius: 0.5rem; font-weight: 500; display: flex; align-items: center;
            gap: 0.75rem; transition: background-color 0.2s, color 0.2s;
        }
        .magic-nav-item:hover { background-color: #F8F9FA; color: var(--tiktok-pink); }
        .magic-nav-item[data-tabid="ai-hashtags"] { display: none; } /* Hide AI Hashtags from magic nav for now */
        .magic-panel-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            opacity: 0; visibility: hidden;
            transition: opacity 0.4s, visibility 0.4s;
            z-index: 1000;
        }
        .magic-panel-overlay.open { opacity: 1; visibility: visible; }

        /* --- Analysis & Popup Styles --- */
        .radio-label {
            display: inline-flex; align-items: center; cursor: pointer; padding: 0.5rem 1rem;
            border-radius: 9999px; border: 1px solid var(--border-color);
            transition: all 0.2s ease; font-size: 0.85rem; font-weight: 500;
            margin-right: 0.5rem; background-color: #F8F9FA;
        }
        .radio-label:hover { border-color: var(--tiktok-pink); }
        .radio-input { display: none; }
        .radio-input:checked + .radio-label {
            background-color: var(--tiktok-pink); color: white; border-color: var(--tiktok-pink);
        }
        .account-score-wrapper {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1.5rem; background-color: #F8F9FA; border-radius: 1rem; border: 1px solid var(--border-color);
        }
        .account-score-value {
            font-size: 4rem; font-weight: 800; line-height: 1;
            background: -webkit-linear-gradient(45deg, var(--tiktok-cyan), var(--tiktok-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .account-score-label { font-weight: 600; color: var(--text-primary); margin-top: 0.5rem; }
        .account-score-description { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem; }
        
        .popup-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 1050;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem;
            transition: opacity 0.3s ease; opacity: 0; visibility: hidden;
            overflow-y: auto;
        }
        .popup-overlay.open { opacity: 1; visibility: visible; }
        .popup-content {
            background-color: var(--bg-card); border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            transform: scale(0.95); transition: transform 0.3s ease;
            position: relative;
            margin: auto;
        }
        #comparison-popup-overlay .popup-content { background-color: var(--bg-main); }
        .popup-overlay.open .popup-content { transform: scale(1); }
        
        .popup-close-btn {
            position: absolute; top: 1.25rem; right: 1.5rem; font-size: 1.5rem;
            color: var(--text-secondary); background: transparent; border: none;
            cursor: pointer; z-index: 10; transition: all 0.2s ease;
        }
        .popup-close-btn:hover { color: var(--text-primary); transform: scale(1.1) rotate(90deg); }

        #single-post-popup-overlay .popup-content { max-width: 640px; padding: 2rem; }
        #cta-popup-overlay .popup-content { max-width: 512px; padding: 2rem; }
        #optimize-popup-overlay .popup-content { max-width: 720px; padding: 2.5rem; }
        #account-worth-popup-overlay .popup-content { max-width: 800px; }
        #comparison-popup-overlay .popup-content { max-width: 900px; padding: 0; }
        
        @keyframes verified-pulse {
          0% { box-shadow: 0 0 0 0 rgba(37, 244, 238, 0.7); }
          70% { box-shadow: 0 0 0 8px rgba(37, 244, 238, 0); }
          100% { box-shadow: 0 0 0 0 rgba(37, 244, 238, 0); }
        }
        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            margin-left: 0.75rem;
            vertical-align: middle;
        }
        .verified-badge.is-verified {
            background-color: var(--tiktok-pink);
            color: white;
            animation: verified-pulse 2s infinite;
        }
        .verified-badge.not-verified {
            background-color: #F1F5F9;
            color: #94A3B8;
        }
        .comparison-line { font-size: 0.9rem; padding: 0.5rem 0.75rem; border-radius: 0.5rem; background-color: #F8F9FA; border: 1px solid #E2E8F0; }

        /* --- Optimization Popup Styles --- */
        .optimization-step {
            display: flex; align-items: center; justify-content: space-between;
            padding: 1rem; margin-bottom: 0.75rem;
            border-radius: 0.75rem; border: 1px solid var(--border-color);
            opacity: 0; transform: translateY(10px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            position: relative;
            z-index: 1;
        }
        .optimization-step:hover {
            z-index: 100;
        }
        .optimization-step.visible { opacity: 1; transform: translateY(0); }
        .optimization-step-text { font-weight: 500; margin: 0 5px;}
        .optimization-step-result { text-align: right; }
        .optimization-step-result .status-text { font-weight: 600; }
        .optimization-step-result .status-good { color: #10B981; }
        .optimization-step-result .status-average { color: #F59E0B; }
        .optimization-step-result .status-bad { color: #EF4444; }
        .optimization-summary { border-top: 2px dashed var(--border-color); margin-top: 1.5rem; padding-top: 1.5rem; }
        @keyframes final-score-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        #final-score-icon { animation: final-score-pulse 2.5s ease-in-out infinite; }

        /* --- Elegant Tooltip --- */
        .opt-tooltip { position: relative; cursor: help; display: inline-flex; align-items: center;}
        .opt-tooltip-icon { color: #CBD5E0; transition: color 0.2s; margin-left: auto; }
        .advanced-metric-item-new .opt-tooltip-icon { margin-left: 0.5rem; }
        .opt-tooltip:hover .opt-tooltip-icon { color: var(--tiktok-pink); }
        .opt-tooltip-text {
            visibility: hidden; opacity: 0;
            background-color: #111827; color: white;
            text-align: left; border-radius: 0.5rem;
            padding: 1rem; width: 340px;
            position: absolute; 
            bottom: 135%; left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.3s, visibility 0.3s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            pointer-events: none;
            z-index: 9999;
        }
        .opt-tooltip.opens-down .opt-tooltip-text {
            top: 130%;
            bottom: auto;
        }
        .opt-tooltip:hover .opt-tooltip-text { visibility: visible; opacity: 1; }
        .opt-tooltip-text h5 { font-weight: 700; margin-bottom: 0.75rem; border-bottom: 1px solid #4B5563; padding-bottom: 0.75rem; }
        .opt-tooltip-text p { font-size: 0.85rem; line-height: 1.5; margin-bottom: 1rem; color: #D1D5DB; font-weight: normal; }
        .opt-tooltip-text ul { list-style: none; padding: 0; font-size: 0.8rem; }
        .opt-tooltip-text li { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem; font-weight: normal; }
        .opt-tooltip-text .fa-lightbulb { color: var(--winner-gold); margin-top: 3px; }

        /* --- JS-Powered Floating Tooltip for Comparison Popup --- */
        #comparison-popup-overlay .opt-tooltip .opt-tooltip-text {
            display: none !important; /* Hide original CSS tooltip to prevent conflict */
        }
        .floating-tooltip {
            position: fixed; /* Use fixed to position relative to viewport */
            background-color: #111827;
            color: white;
            text-align: left;
            border-radius: 0.5rem;
            padding: 1rem;
            width: 340px;
            z-index: 1100; /* Ensure it's on top of the popup overlay */
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translateY(10px);
            pointer-events: none; /* Prevent tooltip from interfering with mouse events */
        }
        .floating-tooltip.active {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .floating-tooltip h5 { font-weight: 700; margin-bottom: 0.75rem; border-bottom: 1px solid #4B5563; padding-bottom: 0.75rem; }
        .floating-tooltip p { font-size: 0.85rem; line-height: 1.5; margin-bottom: 1rem; color: #D1D5DB; font-weight: normal; }
        .floating-tooltip ul { list-style: none; padding: 0; font-size: 0.8rem; }
        .floating-tooltip li { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem; font-weight: normal; }
        .floating-tooltip .fa-lightbulb { color: var(--winner-gold); margin-top: 3px; }


        /* --- Optimize Now Button --- */
        @keyframes pink-pulse { 0% { box-shadow: 0 0 0 0 rgba(254, 44, 85, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(254, 44, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(254, 44, 85, 0); } }
        #optimize-btn { background-color: var(--tiktok-pink); color: white; animation: pink-pulse 2s infinite; transition: background-color 0.2s, transform 0.2s; }
        #optimize-btn:hover { background-color: var(--tiktok-pink-hover); transform: scale(1.05); }
        
        /* --- Account Worth Popup --- */
        #account-worth-popup-overlay .popup-content { padding: 0; background-color: var(--bg-main); }
        #worth-popup-body { padding: 2.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        #worth-popup-body .profile-header-card { box-shadow: none; border: none; padding: 20px; margin: 0; border-bottom: 4px solid var(--tiktok-pink); }
        #worth-popup-body .metrics-grid { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .account-worth-banner { background-color: var(--text-primary); color: white; padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .account-worth-banner h3 { font-size: 1.25rem; font-weight: 500; opacity: 0.8; margin-bottom: 1rem; }
        .account-worth-banner .worth-value { font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; }
        .account-worth-banner .worth-value .odometer { font-size: 3.5rem; font-weight: 800; }
        .account-worth-banner .estimation-note { font-size: 0.9rem; opacity: 0.7; font-style: italic; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 1rem; margin-top: 1rem; }
        .worth-popup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 768px) { .worth-popup-grid { grid-template-columns: 1fr; } }
        .worth-popup-grid .card { margin: 0; }
        .worth-summary-section { background-color: #F8F9FA; border: 1px solid var(--border-color); border-left: 4px solid var(--tiktok-pink); padding: 1.5rem; border-radius: 0.75rem; }
        .worth-summary-section h4 { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.75rem; }
        .worth-summary-section p { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; }
        .worth-summary-section strong { color: var(--text-primary); }
        
        /* --- History Card Design --- */
        #history-section { grid-column: 1 / -1; }
        .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.5rem; }
        @media (min-width: 920px) { .history-grid { grid-template-columns: repeat(3, 1fr); } }
        .history-card { background: #1C1C1F; border-radius: 1rem; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; position: relative; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1); }
        .history-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; z-index: 1; background: conic-gradient( transparent, var(--tiktok-cyan), var(--tiktok-pink), var(--tiktok-cyan), transparent 30% ); animation: spin 4s linear infinite; opacity: 0; transition: opacity 0.4s ease; }
        .history-card:hover { transform: perspective(500px) rotateY(3deg) translateY(-8px); box-shadow: 0 16px 50px rgba(254, 44, 85, 0.15); }
        .history-card:hover::before { opacity: 1; }
        .history-card::after { content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; background: #1C1C1F; border-radius: inherit; z-index: 2; }
        .history-card > * { position: relative; z-index: 3; }
        .history-avatar { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 2px solid #fff; transition: border-color 0.3s ease; }
        .history-card:hover .history-avatar { border-color: var(--tiktok-cyan); }
        .history-name, .history-score .score-value { font-weight: 700; font-size: 1.25rem; color: #fff; }
        .history-username, .history-score { font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); }
        .history-score { margin-bottom: 1rem; }
        .history-score .score-value { font-size: 2rem; line-height: 1; display: block; margin-top: 0.25rem; }
        .history-stars { font-size: 1.1rem; color: var(--winner-gold); margin: 0.5rem 0 1.25rem 0; display: flex; gap: 0.2rem; }
        .history-stars .far.fa-star { color: #4A5568; }
        .history-reanalyze-btn { margin-top: auto; width: 100%; padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 600; color: #fff; background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease; }
        .history-reanalyze-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.3); }
        .history-pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; }
        .history-pagination-btn { background-color: white; border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .history-pagination-btn:hover:not(:disabled) { background-color: var(--tiktok-pink); color: white; border-color: var(--tiktok-pink); }
        .history-pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
/* --- RESPONSIVENESS FIXES --- */
@media (max-width: 768px) {
    .top-nav { flex-direction: column; align-items: flex-start; gap: 1rem; }
    .nav-actions { flex-direction: row; width: 100%; align-items: center; flex-wrap: wrap; }
    .search-group, #open-worth-popup-btn { flex-grow: 1; }
    .search-group { min-width: 200px; }
    .header-hamburger-menu { order: -1; } /* Move hamburger to the start on mobile */
    .comparison-header-redesigned { flex-direction: column; gap: 1.5rem; }
    .header-user-profile-new, .header-user-profile-new.user-2 { width: 100%; flex-direction: row; }
    .header-user-profile-new.user-2 .header-user-info { text-align: right; }
    .header-user-profile-new.user-2 .header-stars { justify-content: flex-start; }
    .header-separator { display: none; }
}
@media (max-width: 640px) {
    .main-container { padding: 1rem; }
    .card { padding: 1rem; }
    .tab-panel { padding: 1rem; }
    .earnings-value { font-size: 2.5rem; }
    .earnings-value .odometer { font-size: 2.5rem; }
    #worth-popup-body { padding: 1.5rem; }
    .account-worth-banner .worth-value { font-size: 2.5rem; }
    .account-worth-banner .worth-value .odometer { font-size: 2.5rem; }
    .post-advanced-metric-grid-new { grid-template-columns: 1fr; }
}

/* --- FIX: Double Scrollbar on Popup --- */
body:has(.popup-overlay.open) {
    overflow: hidden;
}

/* --- Custom Scrollbar Styles --- */
html { scrollbar-width: auto; scrollbar-color: var(--tiktok-pink) var(--bg-main); }
::-webkit-scrollbar { width: 12px; }
::-webkit-scrollbar-track { background: var(--bg-main); }
::-webkit-scrollbar-thumb { background-color: var(--tiktok-pink); border-radius: 10px; border: 3px solid var(--bg-main); }

/* --- Header Hamburger Menu --- */
.header-hamburger-menu {
    position: relative;
    display: flex;
    align-items: center;
}
#header-hamburger-btn {
    width: 44px; /* Match height of search input */
    height: 44px;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    padding: 10px 8px;
    background-color: #F8F9FA;
    border: 1px solid var(--border-color);
    border-right: none;
    border-radius: 0.5rem 0 0 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
}
#header-hamburger-btn:hover {
    background-color: #EFF2F5;
}
#header-hamburger-btn span {
    display: block;
    width: 100%;
    height: 2px;
    background-color: var(--text-primary);
    border-radius: 2px;
    transition: all 0.3s cubic-bezier(.25,1,.5,1);
}
#header-hamburger-btn.active span:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
}
#header-hamburger-btn.active span:nth-child(2) {
    opacity: 0;
    transform: scale(0);
}
#header-hamburger-btn.active span:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
}
#header-hamburger-dropdown {
    display: none; /* Hidden by default */
    position: absolute;
    top: calc(100% + 10px);
    left: 0;
    background-color: #2A2E37; /* Dark background from image */
    border-radius: 0.75rem;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    padding: 0.5rem;
    z-index: 1010;
    width: 240px;
    animation: fadeIn 0.2s ease-out;
}
#header-hamburger-dropdown.active {
    display: block; /* Show on active */
}
.ham-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    color: white;
    text-decoration: none;
    font-weight: 500;
    border-radius: 0.5rem;
    transition: background-color 0.2s ease;
    font-size: 0.9rem;
}
.ham-item:hover {
    background-color: #3C414D;
}
.ham-item i {
    color: var(--tiktok-pink);
    margin-right: 0.75rem;
    font-size: 1.1em;
    transition: transform 0.2s ease;
}
.ham-item:hover i {
    transform: translateX(3px);
}
/* Adjust search input to connect with new hamburger */
.search-group .search-input {
    border-radius: 0; /* Remove left radius */
}
.popup-overlay {
    pointer-events: none;
}

.popup-overlay.open {
    pointer-events: auto;
}
    </style>
<meta property="og:title" content=""><meta property="og:description" content="Tiktok Growth Analyzer 100% Free Tools &gt; No Signup!"><meta property="og:url" content="https://calculatly.com/apps/main/tiktok-growth-analizer.html"><meta property="og:image" content="https://calculatly.com/apps/images/tiktok-growth-tools.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content=""><meta name="twitter:description" content="Tiktok Growth Analyzer 100% Free Tools &gt; No Signup!"><meta name="twitter:image" content="https://calculatly.com/apps/images/tiktok-growth-tools.jpg"></head>
<body>
    <div class="main-container">
        <!-- Header / Navigation -->
        <nav class="top-nav">
            <div class="logo">
                <i class="fab fa-tiktok"></i>
                <span>Tiktok Growth</span>
            </div>
            <div class="nav-actions">
                <div class="header-hamburger-menu">
                    <button id="header-hamburger-btn" aria-label="Open Menu">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <div id="header-hamburger-dropdown">
                        <a href="#" class="ham-item" data-action="tab" data-tabid="single-post"><i class="fas fa-angle-right"></i> Single Post</a>
                        <a href="#" class="ham-item" data-action="tab" data-tabid="comparison"><i class="fas fa-angle-right"></i> Comparison</a>
                        <a href="https://calculatly.com/apps/main/Tiktok-Creator-Strategy-Calculator.html" target="_blank" rel="noopener noreferrer" class="ham-item" data-action="link"><i class="fas fa-angle-right"></i> Advanced Calculator</a>
                        <a href="#" class="ham-item" data-action="popup"><i class="fas fa-angle-right"></i> Earn 10K</a>
                    </div>
                </div>
                <div class="search-group">
                    <div class="input-with-icon-wrapper">
                        <i class="fas fa-at input-icon"></i>
                        <input type="text" id="username" class="search-input" placeholder="Enter TikTok Username" value="tiktok">
                    </div>
                    <button id="fetch-btn" class="search-btn" onclick="fetchProfile(null, true)">Analyze</button>
                </div>
                <button id="open-worth-popup-btn" class="font-semibold text-white px-4 py-3 rounded-lg transition-colors duration-200 bg-gray-800 hover:bg-black">
                    Account Worth
                </button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content">
            <div id="status-container">
                <div class="message-section" id="initial-state">
                    <h2 class="text-2xl font-bold mb-2">Welcome to the Dashboard</h2>
                    <p class="text-gray-500">Enter a public TikTok username to begin your analysis.</p>
                </div>
                <div class="message-section" id="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p class="font-semibold text-gray-600">Analyzing profile, please wait...</p>
                </div>
                <div class="message-section" id="error" style="display: none;">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <p class="font-semibold text-red-500" id="error-text">Unable to fetch profile.</p>
                </div>
            </div>

            <!-- Results -->
            <div class="content-area" id="result" style="display: none;">
                <!-- Left Column -->
                <div class="flex flex-col gap-6">
                    <div class="card profile-header-card">
                        <img id="profile-pic" class="profile-avatar" src="" alt="Profile Picture">
                        <div class="profile-info">
                            <h2 id="display-name" class="profile-name"></h2>
                            <div class="flex items-center justify-center sm:justify-start">
                                <a id="username-link" href="#" target="_blank" rel="noopener noreferrer"><p id="username-text" class="profile-username"></p></a>
                                <span id="verified-badge"></span>
                            </div>
                            <p id="bio" class="profile-bio"></p>
                        </div>
                        <!-- Creator Credibility Display -->
                        <div class="creator-tier-display">
                            <div id="tier-badge" class="tier-badge">
                                <div id="tier-badge-score" class="tier-badge-score"></div>
                            </div>
                            <h4 id="tier-title" class="tier-title"></h4>
                            <p id="tier-description" class="tier-description"></p>
                            <div id="tier-stars" class="tier-stars"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="metrics-grid">
                            <div class="metric-item"><div class="metric-icon"><i class="fas fa-users"></i></div><div><div id="followers" class="metric-value">0</div><div class="metric-label">Followers</div></div></div>
                            <div class="metric-item"><div class="metric-icon"><i class="fas fa-heart"></i></div><div><div id="likes" class="metric-value">0</div><div class="metric-label">Total Likes</div></div></div>
                            <div class="metric-item"><div class="metric-icon"><i class="fas fa-user-plus"></i></div><div><div id="following" class="metric-value">0</div><div class="metric-label">Following</div></div></div>
                            <div class="metric-item"><div class="metric-icon"><i class="fas fa-video"></i></div><div><div id="videos" class="metric-value">0</div><div class="metric-label">Videos</div></div></div>
                        </div>
                    </div><div style="margin:0rem 0rem 0rem 0rem; background-color:#f7f7f7; color:#1a202c; padding:0rem 1.5rem 0rem 1.5rem; border-radius:0.75rem; border:0px none #000000;">
        <style>
            #social-share-container-0 .social-icon-wrapper { position: relative; display: inline-block; }
            #social-share-container-0 .social-icon-wrapper a { display: block; transition: transform 0.2s ease-in-out, color 0.2s ease-in-out; }
            #social-share-container-0 .social-icon-wrapper:hover a { transform: scale(1.2); color: #FE2C55; }
            #social-share-container-0 .social-tooltip { position: absolute; bottom: 140%; left: 50%; transform: translateX(-50%); background-color: #111827; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; pointer-events: none; }
            #social-share-container-0 .social-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #111827 transparent transparent transparent; }
            #social-share-container-0 .social-icon-wrapper:hover .social-tooltip { opacity: 1; visibility: visible; }
        </style><div id="social-share-container-0" class="text-center"><h4 class="font-bold text-lg mb-4"></h4><div class="flex justify-center gap-6 text-3xl"><span class="social-icon-wrapper"><a data-social-key="twitter" href="#" style="color: inherit; text-decoration: none;" title="Share on X (Twitter)"><i class="fab fa-x-twitter"></i></a><span class="social-tooltip">Share on X (Twitter)</span></span><span class="social-icon-wrapper"><a data-social-key="facebook" href="#" style="color: inherit; text-decoration: none;" title="Share on Facebook"><i class="fab fa-facebook"></i></a><span class="social-tooltip">Share on Facebook</span></span><span class="social-icon-wrapper"><a data-social-key="linkedin" href="#" style="color: inherit; text-decoration: none;" title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a><span class="social-tooltip">Share on LinkedIn</span></span><span class="social-icon-wrapper"><a data-social-key="messenger" href="#" style="color: inherit; text-decoration: none;" title="Share on Messenger"><i class="fab fa-facebook-messenger"></i></a><span class="social-tooltip">Share on Messenger</span></span><span class="social-icon-wrapper"><a data-social-key="pinterest" href="#" style="color: inherit; text-decoration: none;" title="Share on Pinterest"><i class="fab fa-pinterest"></i></a><span class="social-tooltip">Share on Pinterest</span></span><span class="social-icon-wrapper"><a data-social-key="telegram" href="#" style="color: inherit; text-decoration: none;" title="Share on Telegram"><i class="fab fa-telegram-plane"></i></a><span class="social-tooltip">Share on Telegram</span></span><span class="social-icon-wrapper"><a data-social-key="whatsapp" href="#" style="color: inherit; text-decoration: none;" title="Share on WhatsApp"><i class="fab fa-whatsapp"></i></a><span class="social-tooltip">Share on WhatsApp</span></span><span class="social-icon-wrapper"><a data-social-key="tumblr" href="#" style="color: inherit; text-decoration: none;" title="Share on Tumblr"><i class="fab fa-tumblr"></i></a><span class="social-tooltip">Share on Tumblr</span></span><span class="social-icon-wrapper"><a data-social-key="pocket" href="#" style="color: inherit; text-decoration: none;" title="Share on Pocket"><i class="fab fa-get-pocket"></i></a><span class="social-tooltip">Share on Pocket</span></span><span class="social-icon-wrapper"><a data-social-key="email" href="#" style="color: inherit; text-decoration: none;" title="Share on Email"><i class="fas fa-envelope"></i></a><span class="social-tooltip">Share on Email</span></span><span class="social-icon-wrapper"><a data-social-key="reddit" href="#" style="color: inherit; text-decoration: none;" title="Share on Reddit"><i class="fab fa-reddit-alien"></i></a><span class="social-tooltip">Share on Reddit</span></span></div></div>
        <script>
        (function(containerId) {
            var container = document.getElementById(containerId);
            if (!container) { return; }
            var shareLinks = container.querySelectorAll('a[data-social-key]');
            var shareData = { title: "", pageUrl: "https://calculatly.com/apps/main/tiktok-growth-analizer.html" };
            var platforms = {
                twitter: 'https://twitter.com/intent/tweet?url=' + encodeURIComponent(shareData.pageUrl) + '&text=' + encodeURIComponent(shareData.title),
                facebook: 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareData.pageUrl),
                messenger: 'https://www.facebook.com/dialog/send?app_id=12345&link=' + encodeURIComponent(shareData.pageUrl) + '&redirect_uri=' + encodeURIComponent(shareData.pageUrl),
                linkedin: 'https://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(shareData.pageUrl) + '&title=' + encodeURIComponent(shareData.title),
                pinterest: 'https://pinterest.com/pin/create/button/?url=' + encodeURIComponent(shareData.pageUrl) + '&description=' + encodeURIComponent(shareData.title),
                reddit: 'https://www.reddit.com/submit?url=' + encodeURIComponent(shareData.pageUrl) + '&title=' + encodeURIComponent(shareData.title),
                whatsapp: 'https://api.whatsapp.com/send?text=' + encodeURIComponent(shareData.title) + '%20' + encodeURIComponent(shareData.pageUrl),
                telegram: 'https://t.me/share/url?url=' + encodeURIComponent(shareData.pageUrl) + '&text=' + encodeURIComponent(shareData.title),
                email: 'mailto:?subject=' + encodeURIComponent(shareData.title) + '&body=' + encodeURIComponent(shareData.pageUrl),
                tumblr: 'https://www.tumblr.com/widgets/share/tool?canonicalUrl=' + encodeURIComponent(shareData.pageUrl) + '&title=' + encodeURIComponent(shareData.title),
                pocket: 'https://getpocket.com/save?url=' + encodeURIComponent(shareData.pageUrl) + '&title=' + encodeURIComponent(shareData.title)
            };
            shareLinks.forEach(function(link) { var key = link.dataset.socialKey; if(platforms[key]) { link.href = platforms[key]; link.target = '_blank'; link.rel = 'noopener noreferrer'; } });
        })('social-share-container-0');
        </script></div>
                    <div class="card earnings-card">
                        <h3 class="card-title">
                            <i class="fas fa-dollar-sign"></i> Estimated Earnings Per Post
                             <span class="tooltip"><i class="fas fa-info-circle tooltip-icon"></i><span class="tooltip-text">An industry-standard estimation based on follower count and engagement. Actual earnings may vary.</span></span>
                        </h3>
                        <div class="earnings-value">$<span id="earnings" class="odometer">0.00</span></div>
                        <p class="earnings-note">*This is an estimate based on follower count and engagement.</p>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200 border-opacity-20">
                            <p id="milestone-text" class="text-white opacity-90 mb-4">Calculating next milestone...</p>
                            <button id="optimize-btn" class="font-bold text-gray-800 bg-white py-2 px-6 rounded-full transition-transform hover:scale-105">Optimize Now</button>
                        </div>
                    </div>
                    
                    <!-- Creator Toolkit (Tabs) -->
                    <div class="card" id="creator-toolkit-card">
                         <h3 class="card-title">
                            <i class="fas fa-tools"></i> Creator Toolkit
                            <span class="tooltip"><i class="fas fa-info-circle tooltip-icon"></i><span class="tooltip-text">A set of tools for deeper analysis, including single post breakdowns and growth tips.</span></span>
                        </h3>
                        <div class="tab-nav">
                            <button id="default-tab" class="tab-btn" onclick="switchTab(event, 'chart-tab')">Analysis</button>
                            <button class="tab-btn" onclick="switchTab(event, 'comparison')">Comparison</button>
                            <button class="tab-btn" onclick="switchTab(event, 'single-post')">Single Post</button>
                            <button class="tab-btn" onclick="switchTab(event, 'ai-hashtags')">AI Hashtags</button>
                            <button class="tab-btn" onclick="switchTab(event, 'ai-bio-creator')">AI Bio Creator</button>
                            <button class="tab-btn" onclick="switchTab(event, 'manual-post')">Manual Post</button>
                        </div>
                        <div class="tab-content text-sm text-gray-600">
                            <div id="chart-tab" class="tab-panel">
                                <div id="account-analysis-section">
                                    <h3 class="text-lg font-bold text-gray-800 mb-4">Account Score &amp; Recommendations</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                                        <div class="account-score-wrapper">
                                            <div class="flex items-center justify-center gap-4">
                                                <i class="fas fa-trophy text-4xl" style="color: var(--winner-gold);"></i>
                                                <div id="account-score-value" class="account-score-value">0</div>
                                            </div>
                                            <div class="account-score-label">Overall Account Score</div>
                                            <p id="account-score-description" class="account-score-description">Based on key performance metrics.</p>
                                        </div>
                                        <div>
                                            <ul id="recommendation-list" class="recommendation-list"></ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <hr class="my-8 border-t border-gray-200">
                                
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Growth Potential &amp; Projections</h3>
                                <p class="text-gray-600 mb-4">Select a projected monthly growth rate to forecast potential follower and earnings growth over the next 6 months. This is an interactive planning tool, not historical data.</p>
                                
                                <div class="mb-6 flex flex-wrap gap-2">
                                    <input type="radio" name="growth-rate" value="3" id="rate-3" class="radio-input" checked="">
                                    <label for="rate-3" class="radio-label">Conservative (3%)</label>
                                    <input type="radio" name="growth-rate" value="7" id="rate-7" class="radio-input">
                                    <label for="rate-7" class="radio-label">Steady (7%)</label>
                                    <input type="radio" name="growth-rate" value="15" id="rate-15" class="radio-input">
                                    <label for="rate-15" class="radio-label">Strong (15%)</label>
                                    <input type="radio" name="growth-rate" value="30" id="rate-30" class="radio-input">
                                    <label for="rate-30" class="radio-label">Viral (30%)</label>
                                </div>
                                <div id="projection-chart" style="min-height: 400px;"></div>
                            </div>
                            <div id="comparison" class="tab-panel">
                                <p class="text-gray-600 mb-3">Enter two public TikTok usernames to compare their core metrics head-to-head in a detailed report.</p>
                                <div class="comparison-inputs mb-4">
                                    <div><label class="form-label">Account 1 (Challenger)</label><input type="text" id="compare-user-1" class="form-input" placeholder="@username1"></div>
                                    <div><label class="form-label">Account 2 (Competitor)</label><input type="text" id="compare-user-2" class="form-input" placeholder="@username2"></div>
                                </div>
                                <button class="cta-btn" onclick="startComparison()"><i class="fas fa-users mr-2"></i>Compare Accounts</button>
                            </div>
                            <div id="single-post" class="tab-panel">
                                 <p class="text-gray-600 mb-3">Paste a full TikTok video URL to get specific analytics and earning estimates for that post.</p>
                                <div class="search-group">
                                    <div class="input-with-icon-wrapper">
                                        <i class="fas fa-link input-icon"></i>
                                        <input type="text" id="post-url-input" class="search-input" placeholder="e.g., https://www.tiktok.com/@user/video/123...">
                                    </div>
                                    <button id="fetch-post-btn" class="search-btn" onclick="fetchPost()">Analyze</button>
                                </div>
                                <div id="post-status-container" class="text-center py-2"></div>
                                <div id="post-analytics-result" style="display: none;">
                                    <!-- New thumbnail and caption section -->
                                    <div id="post-thumbnail-caption-section" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" style="display: none;">
                                        <div class="card">
                                            <h3 class="card-title"><i class="fas fa-image"></i> Post Thumbnail</h3>
                                            <div class="flex items-center justify-center gap-4">
                                                <img id="post-thumbnail" src="" alt="Post Thumbnail" class="max-w-full h-auto rounded-lg shadow-md flex-shrink-0" style="max-height: 300px; max-width: 200px;">
                                                <div class="flex flex-col items-center gap-2">
                                                    <button id="ai-caption-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">AI Caption</button>
                                                    <div id="caption-options" class="hidden flex flex-col gap-2">
                                                        <button id="before-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">Before</button>
                                                        <button id="after-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">After</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card">
                                            <h3 class="card-title"><i class="fas fa-comment"></i> Caption & Tags</h3>
                                            <div id="post-caption-content" class="text-sm text-gray-700 leading-relaxed">
                                                <!-- Caption and hashtags will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                    <div id="post-video-details-bar" class="post-video-details-bar"></div>
                                    <div id="post-advanced-metric-grid-new" class="post-advanced-metric-grid-new"></div>
                                    <div class="post-earnings-display">
                                        <span class="post-earnings-label">Estimated Post Earnings</span>
                                        <div class="post-earnings-value">$<span id="post-earnings-odometer" class="odometer">0.00</span></div>
                                    </div>
                                    <div id="optimize-issues-container"></div>
                                    <div id="post-optimization-checklist" style="display: none;" class="post-optimization-checklist"></div>
                                </div>
                            </div>
                            <div id="ai-hashtags" class="tab-panel">
                                <p class="text-gray-600 mb-3">Generate relevant hashtags for your TikTok content using AI. Enter a topic or description to get optimized hashtags that can boost your reach.</p>
                                <div class="search-group">
                                    <div class="input-with-icon-wrapper">
                                        <i class="fas fa-hashtag input-icon"></i>
                                        <input type="text" id="hashtag-topic-input" class="search-input" placeholder="e.g., Cooking recipes, Dance challenges, Travel tips">
                                    </div>
                                    <button id="generate-hashtags-btn" class="search-btn" onclick="generateHashtags()">Generate</button>
                                </div>
                                <div id="hashtags-status" class="text-center py-2"></div>
                                <div id="hashtags-result" style="display: none;">
                                    <h4 class="text-lg font-bold text-gray-800 mb-4">Generated Hashtags</h4>
                                    <div id="hashtags-list" class="bg-gray-50 p-4 rounded-lg border"></div>
                                    <button class="cta-btn mt-4" onclick="copyHashtags()">Copy All Hashtags</button>
                                </div>
                            </div>
                            <div id="ai-bio-creator" class="tab-panel">
                                <p class="text-gray-600 mb-3">Create an optimized TikTok bio using AI. Describe your content niche and get a professional bio that attracts followers and brands.</p>
                                <div class="search-group">
                                    <div class="input-with-icon-wrapper">
                                        <i class="fas fa-user-edit input-icon"></i>
                                        <input type="text" id="bio-niche-input" class="search-input" placeholder="e.g., Cooking tutorials, Dance challenges, Travel vlogs">
                                    </div>
                                    <button id="generate-bio-btn" class="search-btn" onclick="generateAIBio()">Generate Bio</button>
                                </div>
                                <div id="bio-status" class="text-center py-2"></div>
                                <div id="bio-result" style="display: none;">
                                    <h4 class="text-lg font-bold text-gray-800 mb-4">AI-Generated Bio</h4>
                                    <div id="bio-content" class="bg-gray-50 p-4 rounded-lg border mb-4"></div>
                                    <button class="cta-btn" onclick="copyBio()">Copy Bio</button>
                                </div>
                            </div>
                            <div id="manual-post" class="tab-panel">
                                <p class="text-gray-600 mb-3">Manually create and optimize a TikTok post. Fill in the details below to get content suggestions, hashtags, and posting tips.</p>
                                <div class="space-y-4">
                                    <div>
                                        <label class="form-label">Post Topic/Idea</label>
                                        <input type="text" id="post-topic-input" class="form-input" placeholder="e.g., Quick healthy breakfast recipe">
                                    </div>
                                    <div>
                                        <label class="form-label">Target Audience</label>
                                        <input type="text" id="post-audience-input" class="form-input" placeholder="e.g., Busy parents, Fitness enthusiasts">
                                    </div>
                                    <div>
                                        <label class="form-label">Content Style</label>
                                        <select id="post-style-select" class="form-input">
                                            <option value="educational">Educational</option>
                                            <option value="entertainment">Entertainment</option>
                                            <option value="inspirational">Inspirational</option>
                                            <option value="humorous">Humorous</option>
                                            <option value="trending">Trending Challenge</option>
                                        </select>
                                    </div>
                                    <button id="generate-post-btn" class="cta-btn w-full" onclick="generateManualPost()">Generate Post Plan</button>
                                </div>
                                <div id="post-plan-status" class="text-center py-2"></div>
                                <div id="post-plan-result" style="display: none;">
                                    <h4 class="text-lg font-bold text-gray-800 mb-4">Your Post Plan</h4>
                                    <div id="post-plan-content" class="space-y-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analysis History Section -->
                    <div class="card" id="history-section" style="display: none;">
                        <h3 class="card-title">
                           <i class="fas fa-history"></i> Analysis History
                        </h3>
                        <div id="history-grid" class="history-grid">
                           <!-- History cards will be injected here by JavaScript -->
                        </div>
                        <div id="history-status" class="text-center text-gray-500 py-8" style="display: none;"></div>
                        <div id="history-pagination" class="history-pagination" style="display: none;">
                           <button id="history-prev-btn" class="history-pagination-btn"><i class="fas fa-arrow-left"></i> Previous</button>
                           <span id="history-page-info" class="font-semibold text-gray-600"></span>
                           <button id="history-next-btn" class="history-pagination-btn">Next <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="flex flex-col gap-6">
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-calculator"></i> Earnings Potential Calculator
                             <span class="tooltip"><i class="fas fa-info-circle tooltip-icon"></i><span class="tooltip-text">Interactively forecast potential monthly earnings based on different growth metrics.</span></span>
                        </h3>
                        <div class="space-y-4">
                            <div class="calculator-grid">
                                <div><label class="form-label">Followers</label><input type="number" id="calc-followers" class="form-input"></div>
                                <div><label class="form-label">Avg Views/Video</label><input type="number" id="calc-views" class="form-input"></div>
                                <div><label class="form-label">Videos/Month</label><input type="number" id="calc-videos" class="form-input"></div>
                                <div><label class="form-label">CPM ($)</label><input type="number" id="calc-cpm" class="form-input" step="0.01"></div>
                                <div><label class="form-label">Sponsored Posts</label><input type="number" id="calc-sponsored" class="form-input"></div>
                                <div><label class="form-label">Rate/Post ($)</label><input type="number" id="calc-sponsor-rate" class="form-input" step="10"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-file-invoice-dollar"></i> Estimated Monthly Breakdown
                             <span class="tooltip"><i class="fas fa-info-circle tooltip-icon"></i><span class="tooltip-text">A summary of the earnings calculated in the calculator above, separating ad revenue and sponsorships.</span></span>
                        </h3>
                        <div>
                            <div class="breakdown-item"><span class="item-label">Ad Revenue</span><span id="breakdown-ad" class="item-value">$0.00</span></div>
                            <div class="breakdown-item"><span class="item-label">Sponsorships</span><span id="breakdown-sponsored" class="item-value">$0.00</span></div>
                            <div class="breakdown-item total-breakdown">
                                <span class="item-label font-bold">Total</span>
                                <span class="item-value font-bold">$<span id="breakdown-total" class="odometer">0.00</span></span>
                            </div>
                        </div>
                    </div><div style="margin:0rem 0rem 0rem 0rem; background-color:#111827; color:#F9FAFB; padding:1.4rem 1.5rem 1.4rem 1.5rem; border-radius:1rem; border:0px none #000000;"><div class="text-center"><h3 class="text-2xl font-extrabold">Unlock Your Full Potential</h3><p class="my-4">Go Pro to unlock advanced features.</p><a href="https://calculatly.com/apps/main/Tiktok-Creator-Strategy-Calculator.html" style="display:inline-block; background-color: #fe2c55; color: white; border-radius: 9999px; padding: 0.75rem 2rem; font-weight: 700; text-decoration: none;">Upgrade Now</a></div></div>
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-lightbulb"></i> Performance Insights
                             <span class="tooltip"><i class="fas fa-info-circle tooltip-icon"></i><span class="tooltip-text">Calculated metrics that give a deeper look into account performance and audience engagement.</span></span>
                        </h3>
                        <div>
                            <div class="insight-item"><span class="item-label">Engagement Rate</span><span id="insight-engagement" class="item-value">0%</span></div>
                            <div class="insight-item"><span class="item-label">Avg. Likes per Video</span><span id="insight-avg-likes" class="item-value">0</span></div>
                            <div class="insight-item"><span class="item-label">Content Virality Index</span><span id="insight-virality" class="item-value">0</span></div>
                            <div class="insight-item"><span id="insight-optimization-score-label" class="item-label tooltip">Profile Optimization<span id="optimization-tooltip-text" class="tooltip-text"></span></span><span id="insight-optimization-score" class="item-value">0 / 100</span></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-balance-scale"></i> Profile Health Ratios
                            <span class="tooltip"><i class="fas fa-info-circle tooltip-icon"></i><span class="tooltip-text">Ratios that help gauge the authenticity and influence of the profile.</span></span>
                        </h3>
                        <div>
                            <div class="insight-item">
                                <span class="item-label tooltip">Follower / Following Ratio<span class="tooltip-text">A high ratio (&gt;5) indicates influence. A ratio near 1 is typical.</span></span>
                                <span id="ff-ratio" class="item-value">0</span>
                            </div>
                            <div class="insight-item">
                                <span class="item-label tooltip">Likes / Follower Ratio<span class="tooltip-text">Measures audience loyalty over time. A higher number is better.</span></span>
                                <span id="lf-ratio" class="item-value">0</span>
                            </div>
                            <div class="insight-item"><span class="item-label">Verified Status</span><span id="insight-verified" class="item-value"></span></div>
                            <div class="insight-item"><span class="item-label">Profile Bio</span><span id="insight-bio-status" class="item-value"></span></div>
                        </div>
                    </div>
                    <div id="pdf-download-container">
                        <button id="download-btn" class="w-full justify-center flex items-center py-3 text-base font-semibold rounded-lg transition-colors duration-200 bg-gray-800 text-white hover:bg-black" onclick="downloadReport()" style="display: none;">
                           <i class="fas fa-file-pdf mr-2"></i>Download Full Report
                       </button>
                   </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Magic Navigation Panel -->
    <button id="magic-nav-button" class="magic-nav-button">
        <i class="fas fa-wand-magic-sparkles"></i>
    </button>
    <div id="magic-side-panel" class="magic-side-panel">
        <button id="magic-panel-close" class="magic-panel-close">×</button>
        <h3 class="magic-panel-title">Toolkit Menu</h3>
        <nav class="magic-panel-nav">
            <a href="#" class="magic-nav-item" data-tabid="chart-tab"><i class="fas fa-chart-line fa-fw"></i> Analysis</a>
            <a href="#" class="magic-nav-item" data-tabid="comparison"><i class="fas fa-users fa-fw"></i> Comparison</a>
            <a href="#" class="magic-nav-item" data-tabid="single-post"><i class="fas fa-link fa-fw"></i> Single Post</a>
            <a href="#" class="magic-nav-item" data-tabid="tips"><i class="fas fa-lightbulb fa-fw"></i> Growth Tips</a>
            <a href="#" class="magic-nav-item" data-tabid="faqs"><i class="fas fa-question-circle fa-fw"></i> FAQs</a>
            <a href="#" class="magic-nav-item" data-action="open-cta-popup"><i class="fas fa-dollar-sign fa-fw"></i> Earn $10k/Week</a>
        </nav>
    </div>
    <div id="magic-panel-overlay" class="magic-panel-overlay"></div>

    <!-- CTA Popup -->
    <div id="cta-popup-overlay" class="popup-overlay">
        <div id="cta-popup" class="popup-content">
            <button id="close-cta-popup-btn" class="popup-close-btn">×</button>
            <h2 class="text-2xl md:text-3xl font-extrabold text-center mb-4 text-gray-900">
                Earn $10k Per Week Without a TikTok Account
            </h2>
            <p class="text-gray-600 text-center my-6">
                You've seen the potential of social media, but what if there was a way to tap into that earning power without building a massive following, creating videos, or even showing your face? We've uncovered a system that lets ordinary people generate significant income streams online. This is your chance to see how it works.
            </p>
            <p class="text-gray-800 font-semibold text-center mb-6">
                Click below if you are ready to discover the easiest way to generate $10k, up to $50k, or more per month.
            </p>
            <div class="text-center">
                <a href="#" class="cta-btn !py-3 !px-8 text-lg">
                    Start Now
                </a>
            </div>
        </div>
    </div>
    
    <!-- Single Post Analyzer Popup -->
    <div id="single-post-popup-overlay" class="popup-overlay">
        <div class="popup-content">
            <button id="close-post-popup-btn" class="popup-close-btn">×</button>
            <h3 class="card-title"><i class="fas fa-link"></i>Single Post Analyzer</h3>
            <p class="text-gray-600 mb-3 text-sm">Paste a full TikTok video URL to get specific analytics and earning estimates for that post.</p>
            <div class="search-group">
                <div class="input-with-icon-wrapper">
                    <i class="fas fa-link input-icon"></i>
                    <input type="text" id="post-url-input-popup" class="search-input" placeholder="e.g., https://www.tiktok.com/@user/video/123...">
                </div>
                <button id="fetch-post-btn-popup" class="search-btn" onclick="fetchPost(true)">Analyze</button>
            </div>
            <div id="post-status-container-popup" class="text-center py-2"></div>
            <div id="post-analytics-result-popup" style="display: none;">
                <!-- New thumbnail and caption section for popup -->
                <div id="post-thumbnail-caption-section-popup" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" style="display: none;">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-image"></i> Post Thumbnail</h3>
                        <div class="flex items-center justify-center gap-4">
                            <img id="post-thumbnail-popup" src="" alt="Post Thumbnail" class="max-w-full h-auto rounded-lg shadow-md flex-shrink-0" style="max-height: 300px; max-width: 200px;">
                            <div class="flex flex-col items-center gap-2">
                                <button id="ai-caption-btn-popup" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">AI Caption</button>
                                <div id="caption-options-popup" class="hidden flex flex-col gap-2">
                                    <button id="before-btn-popup" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">Before</button>
                                    <button id="after-btn-popup" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">After</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-comment"></i> Caption & Tags</h3>
                        <div id="post-caption-content-popup" class="text-sm text-gray-700 leading-relaxed">
                            <!-- Caption and hashtags will be populated here -->
                        </div>
                    </div>
                </div>
                <!-- This is the new redesigned section for the popup -->
                <div id="post-video-details-bar-popup" class="post-video-details-bar"></div>
                <div id="post-advanced-metric-grid-new-popup" class="post-advanced-metric-grid-new"></div>
                <div class="post-earnings-display">
                    <span class="post-earnings-label">Estimated Post Earnings</span>
                    <div class="post-earnings-value">$<span id="post-earnings-odometer-popup" class="odometer">0.00</span></div>
                </div>
                <div id="optimize-issues-container-popup"></div>
                <div id="post-optimization-checklist-popup" style="display: none;" class="post-optimization-checklist"></div>
            </div>
        </div>
    </div>
    
    <!-- Optimization Popup -->
    <div id="optimize-popup-overlay" class="popup-overlay">
        <div id="optimize-popup-content" class="popup-content">
            <button id="close-optimize-popup-btn" class="popup-close-btn">×</button>
            <h3 class="card-title text-lg"><i class="fas fa-rocket text-tiktok-pink"></i>Live Profile Optimization Report</h3>
            <div id="optimization-steps-container" class="mt-4 space-y-3"></div>
            <div id="optimization-summary" class="optimization-summary" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="text-center">
                        <div class="flex items-center justify-center gap-4">
                            <i id="final-score-icon" class="text-4xl text-tiktok-pink"></i>
                            <p id="optimization-final-score" class="text-6xl font-extrabold" style="background: -webkit-linear-gradient(45deg, var(--tiktok-cyan), var(--tiktok-pink));-webkit-background-clip: text;-webkit-text-fill-color: transparent;">0</p>
                        </div>
                        <div id="untapped-potential-text" class="text-sm text-gray-600 font-medium bg-gray-100 p-3 rounded-md mt-4"></div>
                    </div>
                    <div style="max-width: 300px; margin: auto;">
                        <canvas id="optimization-radar-chart"></canvas>
                    </div>
                </div>
                <div class="mt-6 bg-blue-50 border-l-4 border-blue-400 p-4 rounded-md">
                    <div class="flex">
                        <div class="flex-shrink-0"><i class="fas fa-info-circle text-blue-500 mt-1"></i></div>
                        <div class="ml-3"><p id="optimization-final-hint" class="text-sm text-blue-700"></p></div>
                    </div>
                </div>
                <div class="text-center">
                    <button id="download-optimization-report-btn" class="cta-btn mt-6"><i class="fas fa-file-pdf mr-2"></i>Download PDF Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Worth Popup -->
    <div id="account-worth-popup-overlay" class="popup-overlay">
        <div id="account-worth-popup-content" class="popup-content">
            <button id="close-worth-popup-btn" class="popup-close-btn">×</button>
            <div id="worth-popup-body">
                <!-- Content will be injected here by JS to match the image structure -->
            </div>
        </div>
    </div>

    <!-- Comparison Popup -->
    <div id="comparison-popup-overlay" class="popup-overlay">
        <div id="comparison-popup-content" class="popup-content">
            <!-- New Header and Body will be injected here by JS -->
        </div>
    </div>


    <script>
        const DOMElements = {
            statusContainer: document.getElementById('status-container'), initialState: document.getElementById('initial-state'), loading: document.getElementById('loading'), error: document.getElementById('error'), errorText: document.getElementById('error-text'), result: document.getElementById('result'), fetchBtn: document.getElementById('fetch-btn'), usernameInput: document.getElementById('username'), downloadBtn: document.getElementById('download-btn'),
            magicNavBtn: document.getElementById('magic-nav-button'), magicSidePanel: document.getElementById('magic-side-panel'), magicPanelClose: document.getElementById('magic-panel-close'), magicPanelOverlay: document.getElementById('magic-panel-overlay'), magicNavItems: document.querySelectorAll('.magic-nav-item'), toolkitCard: document.getElementById('creator-toolkit-card'),
            openWorthPopupBtn: document.getElementById('open-worth-popup-btn'), worthPopupOverlay: document.getElementById('account-worth-popup-overlay'), worthPopupContent: document.getElementById('account-worth-popup-content'), worthPopupBody: document.getElementById('worth-popup-body'), closeWorthPopupBtn: document.getElementById('close-worth-popup-btn'),
            comparisonPopupOverlay: document.getElementById('comparison-popup-overlay'), comparisonPopupContent: document.getElementById('comparison-popup-content')
        };
        
        const cache = {};
        const CACHE_DURATION = 5 * 60 * 1000;
        const PROXY_LIST = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url='
        ];
        
        const API_ENDPOINT = 'https://apps.calculatly.com/apps/tiktok/api.php';
        const LOCAL_STORAGE_KEY = 'tiktok_analysis_history';
        let fullHistory = [];
        let historyCurrentPage = 1;
        const HISTORY_ITEMS_PER_PAGE = 6;

        let totalEarningsOdometer, postEarningsOdometer, postEarningsOdometerPopup;
        let lastProfileStats = null;
        let lastPostItemStruct = null; // Store the last analyzed post
        let optimizationRadarChart = null;
        let confettiHasFiredForThisAnalysis = true;
        let originalCaptionHTML = ''; // Store original caption HTML
        let aiCaptionHTML = ''; // Store AI-generated caption HTML

        // Groq API Key Rotation System
        const GROQ_API_KEYS = [
            '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',
            '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',
            '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',
            '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'
        ];

        let currentApiKeyIndex = 0;
        let apiKeyUsageCount = 0;
        const MAX_REQUESTS_PER_KEY = 10;

        function getNextApiKey() {
            apiKeyUsageCount++;

            // Check if current key has reached the limit
            if (apiKeyUsageCount >= MAX_REQUESTS_PER_KEY) {
                // Rotate to next key
                currentApiKeyIndex = (currentApiKeyIndex + 1) % GROQ_API_KEYS.length;
                apiKeyUsageCount = 0;
                console.log(`Rotated to API key ${currentApiKeyIndex + 1}/${GROQ_API_KEYS.length}`);
            }

            return GROQ_API_KEYS[currentApiKeyIndex];
        }

        function getCurrentApiKeyInfo() {
            return {
                key: GROQ_API_KEYS[currentApiKeyIndex],
                index: currentApiKeyIndex + 1,
                total: GROQ_API_KEYS.length,
                usage: apiKeyUsageCount,
                remaining: MAX_REQUESTS_PER_KEY - apiKeyUsageCount
            };
        }

        function showOriginalCaption() {
            // Handle main version
            const captionContent = document.getElementById('post-caption-content');
            if (captionContent && originalCaptionHTML) {
                captionContent.innerHTML = originalCaptionHTML;
            }

            // Handle popup version
            const captionContentPopup = document.getElementById('post-caption-content-popup');
            if (captionContentPopup && originalCaptionHTML) {
                captionContentPopup.innerHTML = originalCaptionHTML;
            }
        }

        function showAICaption() {
            // Handle main version
            const captionContent = document.getElementById('post-caption-content');
            if (captionContent && aiCaptionHTML) {
                captionContent.innerHTML = aiCaptionHTML;
            } else if (captionContent) {
                console.warn('AI caption not available, showing original');
                showOriginalCaption();
            }

            // Handle popup version
            const captionContentPopup = document.getElementById('post-caption-content-popup');
            if (captionContentPopup && aiCaptionHTML) {
                captionContentPopup.innerHTML = aiCaptionHTML;
            } else if (captionContentPopup) {
                console.warn('AI caption not available for popup, showing original');
                showOriginalCaption();
            }
        }

        async function generateAICaptionHTML(caption, hashtags, mentions, music) {
            try {
                // Show loading state
                const captionContent = document.getElementById('post-caption-content');
                if (captionContent) {
                    captionContent.innerHTML = '<div class="flex items-center justify-center gap-2 py-4"><span class="text-gray-500">Generating AI caption...</span> <div class="spinner !w-4 !h-4 !border-2"></div></div>';
                }

                // Prepare content for AI analysis
                const hashtagText = hashtags.map(h => `#${h.hashtagName}`).join(' ');
                const mentionText = mentions.map(m => `@${m.userUniqueId}`).join(' ');
                const musicText = music ? music.title || 'Original Sound' : 'No music';

                const prompt = `Analyze this TikTok caption and provide an enhanced version with better engagement potential:

Original Caption: "${caption}"
Current Hashtags: ${hashtagText}
Current Mentions: ${mentionText}
Music: ${musicText}

Please provide:
1. An improved caption text (keep it under 150 characters)
2. 5-8 optimized hashtags for better reach
3. 2-3 call-to-action suggestions

Format your response as:
CAPTION: [improved caption text]
HASHTAGS: [space-separated hashtags]
CTAS: [semicolon-separated CTA suggestions]`;

                const currentApiKey = getNextApiKey();
                const keyInfo = getCurrentApiKeyInfo();
                console.log(`Using Groq API key ${keyInfo.index}/${keyInfo.total} (${keyInfo.usage}/${MAX_REQUESTS_PER_KEY} requests)`);

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 300,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI API request failed: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // Parse AI response
                const captionMatch = aiResponse.match(/CAPTION:\s*(.+?)(?:\n|$)/i);
                const hashtagsMatch = aiResponse.match(/HASHTAGS:\s*(.+?)(?:\n|$)/i);
                const ctasMatch = aiResponse.match(/CTAS:\s*(.+?)(?:\n|$)/i);

                const aiCaption = captionMatch ? captionMatch[1].trim() : caption;
                const aiHashtags = hashtagsMatch ? hashtagsMatch[1].trim().split(' ') : [];
                const aiCtas = ctasMatch ? ctasMatch[1].trim().split(';').map(cta => cta.trim()) : [];

                // Generate HTML with pure AI content only (no original content mixed in)
                let aiCaptionHTML = '';

                // AI-generated caption text only
                if (aiCaption) {
                    aiCaptionHTML += `<p class="mb-3 text-gray-800 font-medium">${aiCaption} <span class="text-green-600 text-sm">(AI Generated)</span></p>`;
                }

                // AI-generated hashtags only
                if (aiHashtags.length > 0) {
                    aiCaptionHTML += '<div class="mb-3"><h4 class="text-sm font-semibold text-gray-700 mb-2">AI Hashtags:</h4><div class="flex flex-wrap gap-2">';
                    aiHashtags.forEach(hashtag => {
                        aiCaptionHTML += `<span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">${hashtag}</span>`;
                    });
                    aiCaptionHTML += '</div></div>';
                }

                // AI-generated mentions only (if AI suggests them)
                if (aiCtas.some(cta => cta.toLowerCase().includes('@'))) {
                    aiCaptionHTML += '<div class="mb-3"><h4 class="text-sm font-semibold text-gray-700 mb-2">AI Suggested Tags:</h4><div class="flex flex-wrap gap-2">';
                    aiCtas.filter(cta => cta.toLowerCase().includes('@')).forEach(cta => {
                        const mentionMatch = cta.match(/@\w+/);
                        if (mentionMatch) {
                            aiCaptionHTML += `<span class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs">${mentionMatch[0]}</span>`;
                        }
                    });
                    aiCaptionHTML += '</div></div>';
                }

                // AI music recommendations
                if (music) {
                    aiCaptionHTML += `<div class="mt-3 pt-3 border-t border-gray-200"><h4 class="text-sm font-semibold text-gray-700 mb-2">AI Music Recommendation:</h4><p class="text-sm text-gray-600"><i class="fas fa-music text-pink-500 mr-2"></i>${music.title || 'Original Sound'} <span class="text-blue-600">(AI Suggested)</span></p></div>`;
                }

                // AI-generated call-to-action suggestions only
                if (aiCtas.length > 0) {
                    aiCaptionHTML += '<div class="mt-3 pt-3 border-t border-gray-200"><h4 class="text-sm font-semibold text-gray-700 mb-2">AI Call-to-Actions:</h4><div class="text-sm text-gray-600 space-y-1">';
                    aiCtas.forEach(cta => {
                        aiCaptionHTML += `<p>• ${cta}</p>`;
                    });
                    aiCaptionHTML += '</div></div>';
                }

                // Update both main and popup versions
                const mainCaptionContent = document.getElementById('post-caption-content');
                if (mainCaptionContent) {
                    mainCaptionContent.innerHTML = aiCaptionHTML;
                }

                const popupCaptionContent = document.getElementById('post-caption-content-popup');
                if (popupCaptionContent) {
                    popupCaptionContent.innerHTML = aiCaptionHTML;
                }

                return aiCaptionHTML;

            } catch (error) {
                console.error('AI Caption generation error:', error);

                // Fallback to static content if AI fails
                let aiCaption = '';

                // Enhanced caption text with AI suggestions
                if (caption.trim()) {
                    aiCaption += `<p class="mb-3 text-gray-800 font-medium">${caption} <span class="text-orange-600 text-sm">(AI Enhancement Failed - Showing Original)</span></p>`;
                }

                // AI-optimized hashtags section
                if (hashtags.length > 0) {
                    aiCaption += '<div class="mb-3"><h4 class="text-sm font-semibold text-gray-700 mb-2">AI-Optimized Hashtags:</h4><div class="flex flex-wrap gap-2">';
                    // Add trending hashtags based on content analysis
                    const aiHashtags = ['#Viral', '#Trending', '#TikTok', '#FYP'];
                    hashtags.forEach(hashtag => {
                        aiCaption += `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">#${hashtag.hashtagName}</span>`;
                    });
                    aiHashtags.forEach(hashtag => {
                        aiCaption += `<span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">${hashtag}</span>`;
                    });
                    aiCaption += '</div></div>';
                }

                // Enhanced mentions section
                if (mentions.length > 0) {
                    aiCaption += '<div class="mb-3"><h4 class="text-sm font-semibold text-gray-700 mb-2">Collaborative Mentions:</h4><div class="flex flex-wrap gap-2">';
                    mentions.forEach(mention => {
                        aiCaption += `<span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">@${mention.userUniqueId}</span>`;
                    });
                    aiCaption += '</div></div>';
                }

                // AI music suggestions
                if (music) {
                    aiCaption += `<div class="mt-3 pt-3 border-t border-gray-200"><h4 class="text-sm font-semibold text-gray-700 mb-2">AI Music Analysis:</h4><p class="text-sm text-gray-600"><i class="fas fa-music text-pink-500 mr-2"></i>${music.title || 'Original Sound'} <span class="text-blue-600">(Trending Audio)</span></p></div>`;
                }

                // Add AI-generated call-to-action suggestions
                aiCaption += '<div class="mt-3 pt-3 border-t border-gray-200"><h4 class="text-sm font-semibold text-gray-700 mb-2">AI CTA Suggestions:</h4><div class="text-sm text-gray-600 space-y-1"><p>• "Follow for more amazing content! 🔥"</p><p>• "Comment your thoughts below 👇"</p><p>• "Tag a friend who needs to see this! 👯"</p></div></div>';

                return aiCaption;
            }
        }

        async function fetchWithFallback(url) {
            let lastError;
            for (const proxy of PROXY_LIST) {
                try {
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) throw new Error(`Proxy failed with status ${response.status}`);
                    return response;
                } catch (error) {
                    console.warn(`Proxy ${proxy} failed. Trying next...`, error);
                    lastError = error;
                }
            }
            throw new Error("All analytics services are currently busy or blocked. Please try again later.");
        }

        function showState(state) {
            DOMElements.statusContainer.style.display = (state === 'result') ? 'none' : 'block';
            
            if (state === 'result') {
                DOMElements.result.style.display = 'grid';
                setTimeout(() => {
                    DOMElements.result.style.opacity = 1;
                }, 50);
            } else {
                DOMElements.result.style.display = 'none';
                DOMElements.result.style.opacity = 0;
            }
            
            if (DOMElements.downloadBtn) {
                DOMElements.downloadBtn.style.display = (state === 'result') ? 'flex' : 'none';
            }
            ['initialState', 'loading', 'error'].forEach(s => DOMElements[s].style.display = (s === state) ? 'block' : 'none');
        }
        
        function formatNumber(num) {
            const cleanNum = Math.abs(parseFloat(num));
            if (!isFinite(cleanNum)) return '0';
            if (cleanNum >= 1000000000) return (cleanNum / 1000000000).toFixed(1).replace(/\.0$/, '') + 'G';
            if (cleanNum >= 1000000) return (cleanNum / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (cleanNum >= 1000) return (cleanNum / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            return cleanNum.toLocaleString();
        }
        
        function calculateEarnings(stats, customEngagementRate = null) {
            const followers = Math.abs(parseFloat(stats.followerCount) || 0);
            const likes = Math.abs(parseFloat(stats.heartCount) || 0);
            const videos = Math.max(1, Math.abs(parseFloat(stats.videoCount) || 1));
            const avgLikesPerVideo = likes / videos;
            const engagementRate = customEngagementRate !== null ? customEngagementRate : (followers > 0 ? (avgLikesPerVideo / followers) * 100 : 0);
            const baseSponsorshipValue = followers * 0.0016;
            const engagementMultiplier = Math.min(Math.max(engagementRate / 2.5, 0.75), 2.5);
            return Math.max(0, baseSponsorshipValue * engagementMultiplier);
        }

        function calculateDetailedEarnings() {
            const views = parseInt(document.getElementById('calc-views').value) || 0;
            const cpm = parseFloat(document.getElementById('calc-cpm').value) || 0;
            const sponsored = parseInt(document.getElementById('calc-sponsored').value) || 0;
            const sponsorRate = parseFloat(document.getElementById('calc-sponsor-rate').value) || 0;
            const videos = parseInt(document.getElementById('calc-videos').value) || 1;
            const adRevenue = (views * videos / 1000) * cpm;
            const sponsoredEarnings = sponsored * sponsorRate;
            const totalEarnings = adRevenue + sponsoredEarnings;
            const formatCurrency = (val) => val.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            document.getElementById('breakdown-ad').textContent = formatCurrency(adRevenue);
            document.getElementById('breakdown-sponsored').textContent = formatCurrency(sponsoredEarnings);
            if (totalEarningsOdometer) totalEarningsOdometer.update(totalEarnings);
        }

        function resetCalculator(stats) {
            const followers = Math.abs(stats.followerCount || 0);
            const likes = Math.abs(stats.heartCount || 0);
            const videos = Math.max(1, Math.abs(stats.videoCount || 1));
            const estimatedViews = videos > 0 ? Math.round((likes / videos) * 8) : 1000;
            let defaultCPM = 0.50;
            if (followers > 10000000) defaultCPM = 2.00; else if (followers > 1000000) defaultCPM = 1.25;
            document.getElementById('calc-followers').value = followers;
            document.getElementById('calc-views').value = estimatedViews;
            document.getElementById('calc-videos').value = 15;
            document.getElementById('calc-cpm').value = defaultCPM.toFixed(2);
            document.getElementById('calc-sponsored').value = followers >= 1000000 ? 4 : 1;
            document.getElementById('calc-sponsor-rate').value = followers >= 1000000 ? 1000 : (followers >= 100000 ? 250 : 50);
            calculateDetailedEarnings();
        }

        function updateGrowthGoals(followers) {
            const milestones = [1000, 5000, 10000, 50000, 100000, 500000, 1000000, 5000000, 10000000, 50000000, 100000000, 150000000, 200000000];
            let nextMilestone = milestones.find(m => m > followers) || milestones[milestones.length - 1];
            const needed = Math.max(0, nextMilestone - followers);
            document.getElementById('milestone-text').innerHTML = `<strong class="text-xl">${formatNumber(needed)}</strong> more followers to reach <strong class="text-xl" style="color: var(--tiktok-cyan);">${formatNumber(nextMilestone)}</strong>`;
        }

        function updateHealthRatios(stats, user) {
            const followers = Math.abs(parseFloat(stats.followerCount) || 1);
            const following = Math.abs(parseFloat(stats.followingCount) || 1);
            const likes = Math.abs(parseFloat(stats.heartCount) || 0);
            const ffRatio = (followers / following).toFixed(1);
            const lfRatio = (likes / followers).toFixed(1);
            let ffRatioHTML = `<span class="ratio-dot" style="background-color: var(--winner-gold);"></span> ${ffRatio}`;
            if (ffRatio > 5) ffRatioHTML = `<span class="ratio-dot" style="background-color: #10B981;"></span> ${ffRatio}`;
            if (ffRatio < 1) ffRatioHTML = `<span class="ratio-dot" style="background-color: #EF4444;"></span> ${ffRatio}`;
            document.getElementById('ff-ratio').innerHTML = ffRatioHTML;
            document.getElementById('lf-ratio').textContent = lfRatio;

            const verifiedEl = document.getElementById('insight-verified');
            verifiedEl.innerHTML = user.verified 
                ? `<i class="fas fa-check-circle text-blue-500"></i> Yes` 
                : `<i class="fas fa-times-circle text-gray-400"></i> No`;
            const bioEl = document.getElementById('insight-bio-status');
            bioEl.innerHTML = (user.signature && user.signature.trim() !== '') 
                ? `<i class="fas fa-check-circle text-green-500"></i> Complete` 
                : `<i class="fas fa-times-circle text-gray-400"></i> Missing`;
        }

        function findUserInfo(jsonData) {
            const userModuleKey = Object.keys(jsonData).find(k => k.endsWith('UserModule'));
            if (userModuleKey && jsonData[userModuleKey]?.userMap) {
                const userMap = jsonData[userModuleKey].userMap;
                const userInfo = Object.values(userMap)[0];
                if (userInfo && userInfo.user && userInfo.stats) {
                    return userInfo;
                }
            }
            const oldUserInfo = jsonData?.__DEFAULT_SCOPE__?.['webapp.user-detail']?.userInfo;
            if (oldUserInfo && oldUserInfo.user && oldUserInfo.stats) {
                return oldUserInfo;
            }
            for (const key in jsonData) {
                const potentialData = jsonData[key]?.userInfo;
                if (potentialData && potentialData.user && potentialData.stats && potentialData.user.uniqueId) {
                     return potentialData;
                }
            }
            return null;
        }
        
        async function fetchProfile(usernameOverride = null, isManualSearch = false) {
            const username = (usernameOverride || DOMElements.usernameInput.value.trim()).replace('@', '');

            if (!usernameOverride) {
                const cachedData = cache[username];
                if (cachedData && (Date.now() - cachedData.timestamp < CACHE_DURATION)) {
                    console.log("Serving profile from cache:", username);
                    displayProfile(cachedData.data);
                    if (isManualSearch) {
    saveHistory(cachedData.data); // Also update history on cached view
}
                    return;
                }
            }

            if (!username) {
                if (!usernameOverride) { DOMElements.errorText.textContent = "Please enter a username."; showState('error'); }
                return Promise.reject(new Error("Username is empty."));
            }

            if (!usernameOverride) { showState('loading'); DOMElements.fetchBtn.disabled = true; }
            
            try {
                const tiktokUrl = `https://www.tiktok.com/@${username}`;
                const response = await fetchWithFallback(tiktokUrl);
                
                const html = await response.text();
                const jsonPattern = /<script id="__UNIVERSAL_DATA_FOR_REHYDRATION__" type="application\/json">(.*?)<\/script>/;
                const match = html.match(jsonPattern);
                if (!match || !match[1]) throw new Error("Could not parse profile data.");
                const jsonData = JSON.parse(match[1]);

                const userInfo = findUserInfo(jsonData);

                if (!userInfo) {
                    throw new Error("Profile data structure is invalid or has changed.");
                }
                
           // --- TRICK 1: Save new data to cache ---
if (!usernameOverride) {
    console.log("Saving profile to cache:", username);
    cache[username] = {
        data: userInfo,
        timestamp: Date.now()
    };
    if (isManualSearch) {
        saveHistory(userInfo); // Save to remote history
    }
}
                
                if (usernameOverride) return userInfo;
                displayProfile(userInfo);

            } catch (error) {
                console.error("Fetch Error:", error);
                if (usernameOverride) throw error;
                DOMElements.errorText.textContent = error.message;
                showState('error');
            } finally {
                if (!usernameOverride) DOMElements.fetchBtn.disabled = false;
            }
        }
        
        const tierDataMap = {
    1: { title: 'Shadow', description: 'Just starting out, hidden', animationClass: '' },
    2: { title: 'Echo', description: 'A faint presence, some echoes', animationClass: '' },
    3: { title: 'Spark', description: 'A glimmer of potential', animationClass: '' },
    4: { title: 'Glow Up', description: 'Starting to shine, improving', animationClass: 'is-pulsing' },
    5: { title: 'Buzzin\'', description: 'Gaining attention, creating buzz', animationClass: 'is-pulsing' },
    6: { title: 'Wave Maker', description: 'Making waves, mid-tier influence', animationClass: 'is-pulsing' },
    7: { title: 'Trendling', description: 'Trending within a niche', animationClass: 'is-pulsing' },
    8: { title: 'Hype Star', description: 'Strong performance, audience loves you', animationClass: 'is-pulsing' },
    9: { title: 'Viral Lord', description: 'Near-viral power, dominating feeds', animationClass: 'is-pulsing' },
    10: { title: 'Algorithm Royalty', description: 'Top-tier, TikTok loves you', animationClass: 'is-pulsing' },
};

        function calculateAndAssignTier(stats) {
            const followers = stats.followerCount || 0;
            const engagementRate = parseFloat(document.getElementById('insight-engagement').textContent) || 0;
            const viralityIndex = parseFloat(document.getElementById('insight-virality').textContent) || 0;
            const ffRatio = followers / (stats.followingCount || 1);
            
            const followerScore = Math.min(100, (Math.log10(followers + 1) / 7) * 100);
            const engagementScore = Math.min(100, (engagementRate / 5) * 100);
            const viralityScore = Math.min(100, (viralityIndex / 100) * 100);
            const authorityScore = Math.min(100, (Math.log10(ffRatio + 1) / 2) * 100);
            
            const finalScore = (followerScore * 0.30) + (engagementScore * 0.40) + (viralityScore * 0.15) + (authorityScore * 0.15);
            
            const badgeScore = Math.max(1, Math.min(10, Math.round(finalScore / 10)));
            const stars = Math.round((finalScore / 100) * 10) / 2;
            
            const tierInfo = tierDataMap[badgeScore];
            
            return {
                ...tierInfo,
                badgeScore,
                stars
            };
        }
        
        function renderStars(starRating) {
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= starRating) {
                    starsHTML += '<i class="fas fa-star"></i>';
                } else if (i === Math.ceil(starRating) && starRating % 1 !== 0) {
                    starsHTML += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHTML += '<i class="far fa-star"></i>';
                }
            }
            return starsHTML;
        }

        function displayProfile(userInfo) {
            const { user, stats } = userInfo;
            const followers = Math.abs(stats.followerCount || 0);
            const likes = Math.abs(stats.heartCount || 0);
            const videos = Math.max(1, Math.abs(stats.videoCount || 1));
            document.getElementById('profile-pic').src = user.avatarLarger;
            document.getElementById('display-name').textContent = user.nickname;
            document.getElementById('username-text').textContent = `@${user.uniqueId}`;
            document.getElementById('username-link').href = `https://www.tiktok.com/@${user.uniqueId}`;
            document.getElementById('bio').textContent = user.signature || "No bio available.";
            document.getElementById('followers').textContent = formatNumber(followers);
            document.getElementById('likes').textContent = formatNumber(likes);
            document.getElementById('following').textContent = formatNumber(stats.followingCount);
            document.getElementById('videos').textContent = formatNumber(videos);

            const badgeEl = document.getElementById('verified-badge');
            if (user.verified) {
                badgeEl.className = 'verified-badge is-verified';
                badgeEl.innerHTML = `<i class="fas fa-check"></i> Verified`;
            } else {
                badgeEl.className = 'verified-badge not-verified';
                badgeEl.innerHTML = `<i class="fas fa-times"></i> Not Verified`;
            }
            
            updateHealthRatios(stats, user);
            updateGrowthGoals(followers);
            
            const optimizationResult = calculateProfileOptimization(user);
            document.getElementById('insight-optimization-score').textContent = `${optimizationResult.score} / 100`;
            document.getElementById('optimization-tooltip-text').innerHTML = `<ul>${optimizationResult.checklist.join('')}</ul>`;

            const viralityIndex = calculateViralityIndex(stats);
            document.getElementById('insight-virality').textContent = viralityIndex.toFixed(1);
            
            const engagementRate = followers > 0 ? (((likes / videos) / followers) * 100) : 0;
            const avgLikes = videos > 0 ? Math.round(likes / videos) : 0;
            document.getElementById('insight-engagement').textContent = `${engagementRate.toFixed(2)}%`;
            document.getElementById('insight-avg-likes').textContent = formatNumber(avgLikes);

            const earnings = calculateEarnings(stats);
            const earningsOdometer = new Odometer({ el: document.getElementById('earnings'), value: 0, format: '(,ddd).dd', duration: 2000 });
            setTimeout(() => earningsOdometer.update(earnings), 100);

            const tierData = calculateAndAssignTier(stats);
            const tierBadgeEl = document.getElementById('tier-badge');
            tierBadgeEl.className = 'tier-badge';
            if(tierData.animationClass) {
                tierBadgeEl.classList.add(tierData.animationClass);
            }
            document.getElementById('tier-badge-score').textContent = `${tierData.badgeScore}/10`;
            document.getElementById('tier-title').textContent = tierData.title;
            document.getElementById('tier-description').textContent = tierData.description;
            document.getElementById('tier-stars').innerHTML = renderStars(tierData.stars);

            resetCalculator(stats);
            lastProfileStats = { user, stats };
            confettiHasFiredForThisAnalysis = false;
            showState('result');

            if (document.getElementById('chart-tab').classList.contains('active-panel')) {
                renderAccountAnalysis(stats);
                const checkedRadio = document.querySelector('input[name="growth-rate"]:checked');
                if (checkedRadio) {
                    checkedRadio.dispatchEvent(new Event('change'));
                }
            }
        }

        function downloadReport() {
            const { jsPDF } = window.jspdf;
            const reportArea = document.getElementById('result');
            const username = DOMElements.usernameInput.value || "report";
            DOMElements.downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
            
            html2canvas(reportArea, { scale: 2, backgroundColor: '#F7F8FC' }).then(canvas => {
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const orientation = canvasWidth > canvasHeight ? 'l' : 'p';
                const pdf = new jsPDF({ orientation, unit: 'px', format: [canvasWidth, canvasHeight] });
                const imgData = canvas.toDataURL('image/png', 1.0);
                pdf.addImage(imgData, 'PNG', 0, 0, canvasWidth, canvasHeight);
                pdf.save(`tiktok-report-${username}.pdf`);
                DOMElements.downloadBtn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Download Full Report';
            }).catch(err => {
                 console.error("PDF Generation Failed:", err);
                 DOMElements.downloadBtn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Download Full Report';
            });
        }

        function switchTab(event, tabId) {
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active-panel'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active-tab'));
            event.currentTarget.classList.add('active-tab');
            document.getElementById(tabId).classList.add('active-panel');

            if (tabId === 'chart-tab' && lastProfileStats) {
                setTimeout(() => {
                    renderAccountAnalysis(lastProfileStats.stats);
                    const checkedRadio = document.querySelector('input[name="growth-rate"]:checked');
                    if (checkedRadio) {
                       checkedRadio.dispatchEvent(new Event('change'));
                    }
                }, 50); 
            }
        }
        
        async function fetchPost(isPopup = false) {
            const idSuffix = isPopup ? '-popup' : '';
            const postUrlInput = document.getElementById(`post-url-input${idSuffix}`);
            const fetchPostBtn = document.getElementById(`fetch-post-btn${idSuffix}`);
            const statusContainer = document.getElementById(`post-status-container${idSuffix}`);
            const resultContainer = document.getElementById(`post-analytics-result${idSuffix}`);
            const url = postUrlInput.value.trim();
            
            if (!url || !url.includes('tiktok.com/')) {
                setPostStatus('Please enter a valid TikTok video URL.', true, isPopup);
                return;
            }

            setPostStatus('', false, isPopup);
            resultContainer.style.display = 'none';
            statusContainer.innerHTML = `<div class="flex justify-center items-center gap-2"><span class="text-gray-500">Analyzing post...</span> <div class="spinner !w-6 !h-6 !border-2"></div></div>`;
            fetchPostBtn.disabled = true;

            try {
                const response = await fetchWithFallback(url);
                if (!response.ok) throw new Error(`Could not fetch post (HTTP ${response.status})`);
                const html = await response.text();

                // Debug: Log HTML content length
                console.log("Fetched HTML length:", html.length);

                const jsonPattern = /<script id="__UNIVERSAL_DATA_FOR_REHYDRATION__" type="application\/json">(.*?)<\/script>/;
                const match = html.match(jsonPattern);

                if (!match || !match[1]) {
                    console.error("No JSON script found in HTML");
                    throw new Error("Could not find post data in page. The video might be private, deleted, or the URL format is incorrect.");
                }

                let jsonData;
                try {
                    jsonData = JSON.parse(match[1]);
                } catch (parseError) {
                    console.error("JSON parse error:", parseError);
                    throw new Error("Failed to parse post data. The page structure might have changed.");
                }

                console.log("JSON data keys:", Object.keys(jsonData));

                // Try multiple possible paths for the item data
                let itemInfo = null;

                // Try the original path
                itemInfo = jsonData?.__DEFAULT_SCOPE__?.['webapp.video-detail']?.itemInfo;

                // If not found, try alternative paths
                if (!itemInfo) {
                    console.log("Trying alternative data paths...");

                    // Try different possible locations
                    const possiblePaths = [
                        jsonData?.__DEFAULT_SCOPE__?.['webapp.video-detail']?.itemInfo,
                        jsonData?.itemInfo,
                        jsonData?.ItemModule,
                        jsonData?.__DEFAULT_SCOPE__?.webapp?.videoDetail?.itemInfo
                    ];

                    for (const path of possiblePaths) {
                        if (path && path.itemStruct) {
                            itemInfo = path;
                            console.log("Found itemInfo at alternative path");
                            break;
                        }
                    }
                }

                if (!itemInfo || !itemInfo.itemStruct) {
                    console.error("Available data structure:", jsonData);
                    throw new Error("Post data structure is invalid or video is unavailable. This could be because:\n• The video is private\n• The video has been deleted\n• The URL format is incorrect\n• TikTok has updated their API");
                }

                lastPostItemStruct = itemInfo.itemStruct;
                displayPostAnalytics(lastPostItemStruct, isPopup);
            } catch (error) {
                console.error("Post Fetch Error:", error);
                setPostStatus(error.message, true, isPopup);
            } finally {
                fetchPostBtn.disabled = false;
                statusContainer.innerHTML = '';
            }
        }

        async function generateHashtags() {
            const topic = document.getElementById('hashtag-topic-input').value.trim();
            if (!topic) {
                document.getElementById('hashtags-status').innerHTML = '<span class="text-red-500">Please enter a topic or description.</span>';
                return;
            }

            document.getElementById('hashtags-status').innerHTML = '<span class="text-gray-500">Generating hashtags...</span>';
            document.getElementById('hashtags-result').style.display = 'none';

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [
                            {
                                role: 'user',
                                content: `Generate 10 relevant and optimized hashtags for TikTok content about "${topic}". Make them trending, discoverable, and suitable for viral reach. Return only the hashtags separated by spaces, no other text.`
                            }
                        ],
                        max_tokens: 100,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                const hashtags = data.choices[0].message.content.trim();

                document.getElementById('hashtags-list').innerHTML = hashtags.split(' ').map(tag => `<span class="inline-block bg-gray-200 text-gray-800 px-2 py-1 rounded mr-2 mb-2">${tag}</span>`).join('');
                document.getElementById('hashtags-result').style.display = 'block';
                document.getElementById('hashtags-status').innerHTML = '';

            } catch (error) {
                console.error('Hashtag generation error:', error);
                document.getElementById('hashtags-status').innerHTML = '<span class="text-red-500">Failed to generate hashtags. Please try again.</span>';
            }
        }

        function copyHashtags() {
            const hashtags = document.getElementById('hashtags-list').textContent;
            navigator.clipboard.writeText(hashtags).then(() => {
                alert('Hashtags copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy hashtags.');
            });
        }

        async function generateAIBio() {
            const niche = document.getElementById('bio-niche-input').value.trim();
            if (!niche) {
                document.getElementById('bio-status').innerHTML = '<span class="text-red-500">Please enter a content niche or description.</span>';
                return;
            }

            document.getElementById('bio-status').innerHTML = '<span class="text-gray-500">Generating AI bio...</span>';
            document.getElementById('bio-result').style.display = 'none';

            try {
                const currentApiKey = getNextApiKey();
                const keyInfo = getCurrentApiKeyInfo();
                console.log(`Using Groq API key ${keyInfo.index}/${keyInfo.total} (${keyInfo.usage}/${MAX_REQUESTS_PER_KEY} requests)`);

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [
                            {
                                role: 'user',
                                content: `Create an optimized TikTok bio for a creator who specializes in "${niche}". The bio should be engaging, professional, and under 80 characters. Include relevant emojis and a call-to-action. Make it compelling and brand-appropriate.`
                            }
                        ],
                        max_tokens: 150,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI API request failed: ${response.status}`);
                }

                const data = await response.json();
                const aiBio = data.choices[0].message.content.trim();

                document.getElementById('bio-content').innerHTML = `<div class="text-lg font-medium text-gray-800 mb-2">${aiBio}</div><div class="text-sm text-gray-500">Character count: ${aiBio.length}/80</div>`;
                document.getElementById('bio-result').style.display = 'block';
                document.getElementById('bio-status').innerHTML = '';

            } catch (error) {
                console.error('AI Bio generation error:', error);
                document.getElementById('bio-status').innerHTML = '<span class="text-red-500">Failed to generate bio. Please try again.</span>';
            }
        }

        function copyBio() {
            const bio = document.getElementById('bio-content').querySelector('.text-lg').textContent;
            navigator.clipboard.writeText(bio).then(() => {
                alert('Bio copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy bio.');
            });
        }

        async function generateManualPost() {
            const topic = document.getElementById('post-topic-input').value.trim();
            const audience = document.getElementById('post-audience-input').value.trim();
            const style = document.getElementById('post-style-select').value;

            if (!topic || !audience) {
                document.getElementById('post-plan-status').innerHTML = '<span class="text-red-500">Please fill in all required fields.</span>';
                return;
            }

            document.getElementById('post-plan-status').innerHTML = '<span class="text-gray-500">Generating post plan...</span>';
            document.getElementById('post-plan-result').style.display = 'none';

            try {
                const currentApiKey = getNextApiKey();
                const keyInfo = getCurrentApiKeyInfo();
                console.log(`Using Groq API key ${keyInfo.index}/${keyInfo.total} (${keyInfo.usage}/${MAX_REQUESTS_PER_KEY} requests)`);

                const prompt = `Create a comprehensive TikTok post plan for:
Topic: ${topic}
Target Audience: ${audience}
Content Style: ${style}

Please provide:
1. Hook (first 3 seconds)
2. Main content structure
3. Call-to-action
4. Recommended hashtags (5-8)
5. Best posting time suggestion
6. Expected engagement tips

Format as a structured plan.`;

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 400,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI API request failed: ${response.status}`);
                }

                const data = await response.json();
                const postPlan = data.choices[0].message.content.trim();

                // Format the response nicely
                const formattedPlan = postPlan.split('\n').map(line => {
                    if (line.trim().startsWith('1.') || line.trim().startsWith('2.') || line.trim().startsWith('3.') ||
                        line.trim().startsWith('4.') || line.trim().startsWith('5.') || line.trim().startsWith('6.')) {
                        return `<div class="mb-3"><strong class="text-tiktok-pink">${line.split(':')[0]}:</strong> ${line.split(':').slice(1).join(':')}</div>`;
                    }
                    return line ? `<div class="mb-2">${line}</div>` : '';
                }).join('');

                document.getElementById('post-plan-content').innerHTML = `<div class="bg-gray-50 p-4 rounded-lg border text-sm leading-relaxed">${formattedPlan}</div>`;
                document.getElementById('post-plan-result').style.display = 'block';
                document.getElementById('post-plan-status').innerHTML = '';

            } catch (error) {
                console.error('Manual Post generation error:', error);
                document.getElementById('post-plan-status').innerHTML = '<span class="text-red-500">Failed to generate post plan. Please try again.</span>';
            }
        }

        function setPostStatus(message, isError = false, isPopup = false) {
            const idSuffix = isPopup ? '-popup' : '';
            const container = document.getElementById(`post-status-container${idSuffix}`);
            const resultEl = document.getElementById(`post-analytics-result${idSuffix}`);
            resultEl.style.display = 'none';
            container.innerHTML = message ? (isError ? `<span class="text-red-500 font-semibold">${message}</span>` : `<span class="text-gray-500">${message}</span>`) : '';
        }

        function calculatePostEarnings(stats) {
            const views = stats.playCount || 0;
            const cpm = 0.50; 
            return (views / 1000) * cpm;
        }
        
        function displayPostAnalytics(itemStruct, isPopup = false) {
            if (!lastProfileStats) {
                alert("Please analyze a user profile first to get comparative data.");
                return;
            }
            const idSuffix = isPopup ? '-popup' : '';

            // Show and populate thumbnail and caption section
            const thumbnailSection = document.getElementById(`post-thumbnail-caption-section${idSuffix}`);
            if (thumbnailSection) {
                thumbnailSection.style.display = 'grid';

                // Set thumbnail image
                const thumbnailImg = document.getElementById(`post-thumbnail${idSuffix}`);
                if (thumbnailImg && itemStruct.video?.cover) {
                    thumbnailImg.src = itemStruct.video.cover;
                }

                // Populate caption and hashtags
                const captionContent = document.getElementById(`post-caption-content${idSuffix}`);
                if (captionContent) {
                    const caption = itemStruct.desc || '';
                    const hashtags = itemStruct.textExtra?.filter(t => t.hashtagName) || [];
                    const mentions = itemStruct.textExtra?.filter(t => !t.hashtagName) || [];

                    let captionHTML = '';

                    // Display caption text
                    if (caption.trim()) {
                        captionHTML += `<p class="mb-3 text-gray-800 font-medium">${caption}</p>`;
                    }

                    // Display hashtags
                    if (hashtags.length > 0) {
                        captionHTML += '<div class="mb-3"><h4 class="text-sm font-semibold text-gray-700 mb-2">Hashtags:</h4><div class="flex flex-wrap gap-2">';
                        hashtags.forEach(hashtag => {
                            captionHTML += `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">#${hashtag.hashtagName}</span>`;
                        });
                        captionHTML += '</div></div>';
                    }

                    // Display mentions
                    if (mentions.length > 0) {
                        captionHTML += '<div class="mb-3"><h4 class="text-sm font-semibold text-gray-700 mb-2">Mentions:</h4><div class="flex flex-wrap gap-2">';
                        mentions.forEach(mention => {
                            captionHTML += `<span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">@${mention.userUniqueId}</span>`;
                        });
                        captionHTML += '</div></div>';
                    }

                    // Display music info
                    if (itemStruct.music) {
                        captionHTML += `<div class="mt-3 pt-3 border-t border-gray-200"><h4 class="text-sm font-semibold text-gray-700 mb-2">Music:</h4><p class="text-sm text-gray-600"><i class="fas fa-music text-pink-500 mr-2"></i>${itemStruct.music.title || 'Original Sound'}</p></div>`;
                    }

                    // Store original caption HTML and show it initially
                    originalCaptionHTML = captionHTML;
                    aiCaptionHTML = ''; // Will be generated when AI button is clicked

                    captionContent.innerHTML = captionHTML;

                    // Reset AI caption UI state for new video
                    const aiBtn = document.getElementById(`ai-caption-btn${idSuffix}`);
                    const captionOptions = document.getElementById(`caption-options${idSuffix}`);
                    if (aiBtn) {
                        aiBtn.classList.remove('hidden');
                    }
                    if (captionOptions) {
                        captionOptions.classList.add('hidden');
                    }
                }
            }

            const optimizeBtnContainer = document.getElementById(`optimize-issues-container${idSuffix}`);
            const checklistContainer = document.getElementById(`post-optimization-checklist${idSuffix}`);
            checklistContainer.style.display = 'none';
            checklistContainer.innerHTML = '';
            optimizeBtnContainer.innerHTML = `<button class="optimization-tips-btn" onclick="revealOptimization('${idSuffix}')"><i class="fas fa-lightbulb"></i>Optimization Tips</button>`;

            const postStats = itemStruct.stats;
            const views = postStats.playCount || 0;
            const likes = postStats.diggCount || 0;
            const comments = postStats.commentCount || 0;
            const shares = postStats.shareCount || 0;
            const saves = postStats.collectCount || 0;
            const duration = itemStruct.video.duration || 0;
            const createTime = itemStruct.createTime;
            const hashtags = itemStruct.textExtra?.filter(t => t.hashtagName) || [];
            const musicTitle = itemStruct.music.title || 'Original Sound';

            const accountStats = lastProfileStats.stats;
            const accountVideos = Math.max(1, accountStats.videoCount || 1);
            const accountAvgViews = (accountStats.playCount || (accountStats.heartCount * 8)) / accountVideos;
            const accountAvgLikes = accountStats.heartCount / accountVideos;
            const accountAvgComments = accountStats.commentCount / accountVideos;
            const accountAvgShares = accountStats.shareCount / accountVideos;
            const accountAvgSaves = (accountStats.collectCount || 0) / accountVideos;
            
            const postTotalInteractions = likes + comments + shares + saves;
            const accountAvgTotalInteractions = (accountStats.heartCount + accountStats.commentCount + accountStats.shareCount + (accountStats.collectCount || 0)) / accountVideos;

            const hoursSincePost = Math.max(1, (Date.now() - (createTime * 1000)) / (1000 * 60 * 60));
            const velocityScore = (likes + (comments * 2) + (shares * 5)) / hoursSincePost;
            const avgVelocityScore = (accountAvgLikes + (accountAvgComments * 2) + (accountAvgShares * 5)) / 24;

            const engagementDensity = (postTotalInteractions / Math.max(1, views)) * 1000;
            const avgEngagementDensity = (accountAvgTotalInteractions / Math.max(1, accountAvgViews)) * 1000;

            const audienceHookRate = Math.min(15, (likes / Math.max(1, views)) * 100 * 1.5) + (duration < 15 ? 1.5 : 0);
            const avgAudienceHookRate = Math.min(15, (accountAvgLikes / Math.max(1, accountAvgViews)) * 100 * 1.5);
            
            let strategicScore = 0;
            if (likes > accountAvgLikes) strategicScore += 3;
            if ((postTotalInteractions/views) > (accountAvgTotalInteractions/accountAvgViews)) strategicScore += 2;
            if (hashtags.length >= 3) strategicScore += 2;
            if (!itemStruct.music.isOriginal) strategicScore += 1;
            if (duration >= 7 && duration <= 60) strategicScore += 2;
            strategicScore = Math.min(10, Math.round(strategicScore));
            const avgStrategicScore = 6.5;

            const postEngagementRate = views > 0 ? (postTotalInteractions / views) * 100 : 0;
            const avgHashtagCount = 4; // Baseline average

            const formatPostDiff = (current, average) => {
                if (average === 0 && current > 0) return `<span class="delta delta-positive">+NEW</span>`;
                if (average === 0) return '';
                const diff = ((current - average) / average) * 100;
                if (!isFinite(diff)) return '';
                const isPositive = diff >= 0;
                const colorClass = isPositive ? 'delta-positive' : 'delta-negative';
                const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
                const sign = isPositive ? '+' : '';
                return `<span class="delta ${colorClass}"><i class="fas ${icon} fa-xs"></i> ${sign}${diff.toFixed(0)}%</span>`;
            };

            document.getElementById(`post-video-details-bar${idSuffix}`).innerHTML = `
                <div class="detail-item"><i class="fas fa-video"></i><span>Video Details:</span></div>
                <div class="detail-item"><span>Posted On: ${new Date(createTime * 1000).toLocaleDateString()}</span></div>
                <div class="detail-item"><span>Duration: ${duration}s</span></div>
            `;
            
            document.getElementById(`post-advanced-metric-grid-new${idSuffix}`).innerHTML = `
                <div class="advanced-metric-item-new"><i class="fas fa-eye icon"></i><span class="label">Views</span><div class="value-container"><span class="value">${formatNumber(views)}</span>${formatPostDiff(views, accountAvgViews)}</div>${generateMetricTooltip('views', views, accountAvgViews)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-heart icon"></i><span class="label">Likes</span><div class="value-container"><span class="value">${formatNumber(likes)}</span>${formatPostDiff(likes, accountAvgLikes)}</div>${generateMetricTooltip('likes', likes, accountAvgLikes)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-comments icon"></i><span class="label">Comments</span><div class="value-container"><span class="value">${formatNumber(comments)}</span>${formatPostDiff(comments, accountAvgComments)}</div>${generateMetricTooltip('comments', comments, accountAvgComments)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-share icon"></i><span class="label">Shares</span><div class="value-container"><span class="value">${formatNumber(shares)}</span>${formatPostDiff(shares, accountAvgShares)}</div>${generateMetricTooltip('shares', shares, accountAvgShares)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-bookmark icon"></i><span class="label">Saves</span><div class="value-container"><span class="value">${formatNumber(saves)}</span>${formatPostDiff(saves, accountAvgSaves)}</div>${generateMetricTooltip('saves', saves, accountAvgSaves)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-percent icon"></i><span class="label">Engagement Rate</span><div class="value-container"><span class="value">${postEngagementRate.toFixed(2)}%</span></div>${generateMetricTooltip('engagement', postEngagementRate, 0)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-bolt icon"></i><span class="label">Velocity Score</span><div class="value-container"><span class="value">${velocityScore.toFixed(1)}</span>${formatPostDiff(velocityScore, avgVelocityScore)}</div>${generateMetricTooltip('velocity', velocityScore, avgVelocityScore)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-users-rays icon"></i><span class="label">Engagement Density</span><div class="value-container"><span class="value">${engagementDensity.toFixed(1)}</span>${formatPostDiff(engagementDensity, avgEngagementDensity)}</div>${generateMetricTooltip('density', engagementDensity, avgEngagementDensity)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-magnet icon"></i><span class="label">Audience Hook Rate</span><div class="value-container"><span class="value">${audienceHookRate.toFixed(1)}%</span>${formatPostDiff(audienceHookRate, avgAudienceHookRate)}</div>${generateMetricTooltip('hook', audienceHookRate, avgAudienceHookRate)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-chess-king icon"></i><span class="label">Strategic Score</span><div class="value-container"><span class="value">${strategicScore}/10</span>${formatPostDiff(strategicScore, avgStrategicScore)}</div>${generateMetricTooltip('strategy', strategicScore, avgStrategicScore)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-hashtag icon"></i><span class="label">Hashtags</span><div class="value-container"><span class="value">${hashtags.length}</span>${formatPostDiff(hashtags.length, avgHashtagCount)}</div>${generateMetricTooltip('hashtags', hashtags.length, avgHashtagCount)}</div>
                <div class="advanced-metric-item-new"><i class="fas fa-music icon"></i><span class="label">Music Title</span><div class="value-container"><span class="value">${musicTitle}</span></div>${generateMetricTooltip('music', 0, 0)}</div>
            `;
            
            const odometer = isPopup ? postEarningsOdometerPopup : postEarningsOdometer;
            odometer.update(calculatePostEarnings(postStats));
            
            document.getElementById(`post-analytics-result${idSuffix}`).style.display = 'block';
        }
        
        function revealOptimization(idSuffix) {
            const checklistContainer = document.getElementById(`post-optimization-checklist${idSuffix}`);
            const optimizeBtnContainer = document.getElementById(`optimize-issues-container${idSuffix}`);
            
            if (checklistContainer.style.display === 'flex') {
                checklistContainer.style.display = 'none';
                return;
            }

            optimizeBtnContainer.innerHTML = `<div class="post-analyzer-loading-bar"><div id="pro-tips-bar-fill${idSuffix}" class="post-analyzer-loading-bar-fill"></div></div>`;
            
            setTimeout(() => {
                document.getElementById(`pro-tips-bar-fill${idSuffix}`).style.width = '100%';
            }, 50);

            setTimeout(() => {
                const adviceList = generatePostOptimizationAdvice(lastPostItemStruct);
                checklistContainer.innerHTML = adviceList.map(item => `
                    <div class="checklist-item ${item.status}">
                        <i class="fas ${item.icon} icon"></i>
                        <div class="text-content">
                            <div class="title">${item.title}</div>
                            <div class="description">${item.description}</div>
                        </div>
                    </div>
                `).join('');
                optimizeBtnContainer.innerHTML = `<button class="optimization-tips-btn" onclick="revealOptimization('${idSuffix}')"><i class="fas fa-lightbulb"></i>Optimization Tips</button>`;
                checklistContainer.style.display = 'flex';
            }, 5000);
        }
        
        function generatePostOptimizationAdvice(itemStruct) {
             const advice = [];
            const caption = itemStruct.desc || '';
            const hashtags = itemStruct.textExtra?.filter(t => t.hashtagName) || [];
            const mentions = itemStruct.textExtra?.filter(t => !t.hashtagName) || [];

            if (caption.length > 50) advice.push({ status: 'status-good', icon: 'fa-check-circle', title: 'Informative Caption', description: 'The caption provides good context and is long enough to engage viewers.' });
            else if (caption.length > 10) advice.push({ status: 'status-warning', icon: 'fa-lightbulb', title: 'Caption Length', description: 'Caption is okay, but could be more descriptive to improve SEO and context.' });
            else advice.push({ status: 'status-danger', icon: 'fa-exclamation-triangle', title: 'Short Caption', description: 'The caption is very short. A more detailed caption can improve discoverability.' });

            if (/follow|comment|link in bio|shop|click|part 2/i.test(caption)) advice.push({ status: 'status-good', icon: 'fa-check-circle', title: 'Strong CTA', description: 'A clear Call-to-Action is included in the caption, which helps drive engagement.' });
            else advice.push({ status: 'status-warning', icon: 'fa-lightbulb', title: 'Missing CTA', description: 'Add a Call-to-Action (e.g., "Follow for Part 2", "Comment your thoughts!") to boost engagement.' });

            if (hashtags.length >= 3 && hashtags.length <= 6) advice.push({ status: 'status-good', icon: 'fa-check-circle', title: 'Optimal Hashtags', description: `Using ${hashtags.length} hashtags is a great strategy for discoverability.` });
            else if (hashtags.length > 6) advice.push({ status: 'status-danger', icon: 'fa-exclamation-triangle', title: 'Hashtag Count', description: `Using ${hashtags.length} hashtags may be suboptimal and dilute your reach. Aim for 3-6 relevant hashtags.` });
            else advice.push({ status: 'status-warning', icon: 'fa-lightbulb', title: 'Low Hashtag Count', description: `Only ${hashtags.length} hashtags were used. Consider adding more relevant hashtags (3-6 is ideal) to expand reach.` });

            if (!itemStruct.music.isOriginal) advice.push({ status: 'status-good', icon: 'fa-check-circle', title: 'Sound Choice', description: 'Using popular audio can significantly boost reach and fits well with the platform\'s culture.' });
            else advice.push({ status: 'status-warning', icon: 'fa-lightbulb', title: 'Original Sound', description: 'Using an original sound is great for branding, but leveraging trending audio can often lead to wider visibility.' });

            if (mentions.length > 0) advice.push({ status: 'status-good', icon: 'fa-check-circle', title: 'Collaborative Tagging', description: 'Tagging other accounts or brands is a great way to increase visibility and engagement.' });
            else advice.push({ status: 'status-warning', icon: 'fa-lightbulb', title: 'Tagging Opportunity', description: 'Consider tagging relevant accounts, brands, or collaborators in future posts to expand visibility.' });
            
            advice.push({ status: 'status-info', icon: 'fa-info-circle', title: 'Pro Tip', description: 'Ensure your videos are uploaded in the highest possible resolution (e.g., 1080p) for best performance and viewer experience.' });

            return advice;
        }

        async function startComparison() {
            const usernames = [
                document.getElementById('compare-user-1').value.trim(),
                document.getElementById('compare-user-2').value.trim(),
            ].filter(Boolean);

            if (usernames.length < 2) {
                alert("Please enter two usernames to compare.");
                return;
            }
            
            DOMElements.comparisonPopupOverlay.classList.add('open');
            DOMElements.comparisonPopupContent.innerHTML = `<div class="flex items-center justify-center p-8"><div class="spinner !w-8 !h-8"></div><span class="ml-4 text-lg text-gray-600">Running head-to-head analysis...</span></div>`;
            
            await fetchComparison();
        }

        function generateMetricTooltipHTML(tooltip) {
            if (!tooltip) return '';
            return `
                <h5>${tooltip.title}</h5>
                <p>${tooltip.desc}</p>
                <ul>
                    ${tooltip.tips.map(tip => `<li><i class="fas fa-lightbulb"></i><span>${tip}</span></li>`).join('')}
                </ul>
            `;
        }
        
        function generateMetricTooltip(metric, postValue, avgValue) {
            const diff = avgValue > 0 ? (postValue - avgValue) / avgValue : (postValue > 0 ? 1 : 0);
            let level = 'average';
            if (diff > 0.25) level = 'high';
            if (diff < -0.25) level = 'low';

            const content = {
                velocity: { title: "Velocity Score", high: { desc: "Excellent momentum! This post is gaining traction much faster than your average content.", tip: "Double down on this format; the algorithm is clearly favoring it right now." }, average: { desc: "Solid velocity. This post is performing on par with your other content in terms of early engagement speed.", tip: "To boost this, try posting when your audience is most active." }, low: { desc: "Slow start. This post is gaining traction slower than usual. The initial hook may not be strong enough.", tip: "Analyze the first 3 seconds. Was the opening captivating enough to stop the scroll?" }},
                density: { title: "Engagement Density", high: { desc: "Incredibly engaging content! For every 1000 views, this post generates a high number of interactions, indicating strong viral potential.", tip: "This content is highly effective. Create a series or follow-up video in this style." }, average: { desc: "Good density. The engagement-to-view ratio is consistent with your account's average performance.", tip: "To improve, add a more direct Call-to-Action in your caption or on-screen text." }, low: { desc: "Low engagement per view. Viewers are watching but not interacting as much as they do with your other content.", tip: "Make the content more interactive. Ask a question or encourage a duet to boost interactions." }},
                hook: { title: "Audience Hook Rate", high: { desc: "Fantastic hook! The first few seconds of this video are exceptionally good at grabbing and retaining viewer attention.", tip: "Your opening is a key strength here. Replicate the visual style or editing of the first 3 seconds." }, average: { desc: "Effective hook. The video's opening is performing as expected and keeping viewers engaged.", tip: "Experiment with a more controversial statement or a surprising visual right at the start." }, low: { desc: "Weak hook. The opening isn't capturing attention as well as your other videos, leading to potential scroll-aways.", tip: "Your video needs to provide value or intrigue immediately. Don't waste the first 2 seconds." }},
                strategy: { title: "Strategic Score", high: { desc: "Excellent strategy. This post checks multiple boxes for what the algorithm likes: good length, trending elements, and high engagement.", tip: "This is a blueprint for success. Analyze why it scored high and apply those lessons." }, average: { desc: "Solid strategy. The post follows some best practices but has room for optimization.", tip: "Review your hashtag strategy and ensure you're using a trending (but relevant) sound." }, low: { desc: "Strategy needs review. This post is missing several key optimization elements, limiting its potential reach.", tip: "Focus on the basics: use 3-5 relevant hashtags, a trending sound, and ensure the video is high-quality." }},
                views: { title: "Views", high: { desc: "Viral Performance! This post has reached a significantly larger audience than your average video.", tip: "The algorithm loves this. Identify the core appeal and create similar content to capitalize on the momentum." }, average: { desc: "Consistent Reach. This video's viewership is in line with your typical performance.", tip: "To break through a view plateau, try collaborating with another creator or promoting the video on other platforms." }, low: { desc: "Underperforming Reach. This post didn't reach as many people as your other content.", tip: "This could be due to a weak hook or low initial engagement. Review the first-hour performance." }},
                likes: { title: "Likes", high: { desc: "Audience Favorite! The like-to-view ratio is exceptional, showing viewers strongly resonate with this content.", tip: "This content connects emotionally. Lean into the style, topic, or message that earned these likes." }, average: { desc: "Good Response. The number of likes is consistent with your typical viewership.", tip: "To increase likes, try creating more relatable content or a more satisfying video conclusion." }, low: { desc: "Lower Interest. Viewers are not liking this post as frequently as your others.", tip: "The content might be too niche or not as relatable. Survey your audience to see what they want more of." }},
                comments: { title: "Comments", high: { desc: "Conversation Starter! This post is generating a high level of discussion and community interaction.", tip: "High comment volume is a huge signal to the algorithm. Continue asking questions and creating debatable content." }, average: { desc: "Steady Discussion. The comment volume is typical for your posts.", tip: "Prompt a response directly. Ask, 'What do you think?' or 'Tell me about your experience'." }, low: { desc: "Low Interaction. This post isn't sparking much conversation.", tip: "Make your content more open-ended. Avoid videos that have a simple 'yes' or 'no' conclusion." }},
                shares: { title: "Shares", high: { desc: "Highly Shareable! This content is relatable or useful enough that viewers are sharing it widely.", tip: "Shareable content is key to viral growth. Create more tutorials, surprising facts, or 'send this to a friend' type videos." }, average: { desc: "Average Sharability. The post is being shared at a normal rate for your account.", tip: "Think about what would make someone share this. Is it funny, educational, or shocking?" }, low: { desc: "Low Sharability. Viewers are consuming the content but not sharing it with others.", tip: "This content may lack a strong emotional trigger or utility. Aim for content that makes people say 'wow' or 'so true'." }},
                saves: { title: "Saves", high: { desc: "High Utility! Viewers find this content so valuable they are saving it for later, a strong signal to the algorithm.", tip: "This is a huge win. Create more content that is educational, inspirational, or provides a resource (like a recipe or tip)." }, average: { desc: "Good Utility. The save rate is on par with your other content.", tip: "To increase saves, use on-screen text to create lists or step-by-step guides that viewers will want to reference." }, low: { desc: "Low Utility. Viewers don't see a reason to save this post for later.", tip: "Focus on providing clear, actionable value. If it's not educational or inspirational, it likely won't be saved." }},
                engagement: { title: "Engagement Rate (vs Views)", default: {desc: "This rate measures the percentage of viewers who interacted with the post (liked, commented, shared, or saved).", tip: "A higher rate indicates more engaging content. Aim for a rate above 5% for good performance and above 10% for viral potential."}},
                hashtags: { title: "Hashtag Count", high: { desc: "This post uses more hashtags than your average video.", tip: "Ensure they are all highly relevant. Too many broad hashtags can dilute your video's niche targeting." }, average: { desc: "The number of hashtags is consistent with your usual strategy.", tip: "Continue using a mix of broad and niche hashtags for optimal reach." }, low: { desc: "Fewer hashtags were used on this post than normal.", tip: "Consider adding 3-5 relevant hashtags to improve discoverability in searches and on the FYP." }},
                music: { title: "Music Title", default: {desc: "This is the audio track used in the video. Using trending sounds can significantly increase a video's reach.", tip: "Check the 'For You' page to see if this sound is currently popular. If not, prioritize using trending audio in your next posts."} }
            };

            const data = content[metric];
            let result;
            if (metric === 'engagement' || metric === 'music') {
                result = data.default;
            } else {
                result = data[level];
            }
            
            if (!result) return ''; // Failsafe
            
            const tooltipHTML = `<span class="opt-tooltip"><i class="fas fa-info-circle opt-tooltip-icon"></i><span class="opt-tooltip-text"><h5>${data.title}</h5><p>${result.desc}</p><ul><li><i class="fas fa-lightbulb"></i><span>${result.tip}</span></li></ul></span></span>`;
            return tooltipHTML;
        }

        // New robust tooltip handler for the comparison popup
        function activateComparisonTooltips() {
            const tooltipTriggers = document.querySelectorAll('#comparison-popup-content .opt-tooltip');
            let activeTooltip = null;
        
            tooltipTriggers.forEach(trigger => {
                const icon = trigger.querySelector('.opt-tooltip-icon');
                const contentHTML = trigger.querySelector('.opt-tooltip-text').innerHTML;
        
                icon.addEventListener('mouseenter', (e) => {
                    // Remove any existing tooltip
                    if (activeTooltip) {
                        activeTooltip.remove();
                    }
        
                    // Create and append the new tooltip to the body
                    activeTooltip = document.createElement('div');
                    activeTooltip.className = 'floating-tooltip';
                    activeTooltip.innerHTML = contentHTML;
                    document.body.appendChild(activeTooltip);
        
                    // Position the tooltip
                    const iconRect = icon.getBoundingClientRect();
                    const tooltipRect = activeTooltip.getBoundingClientRect();
                    
                    let top = iconRect.top - tooltipRect.height - 10;
                    let left = iconRect.left + (iconRect.width / 2) - (tooltipRect.width / 2);

                    // Adjust if it goes off-screen
                    if (top < 0) {
                        top = iconRect.bottom + 10;
                    }
                    if (left < 0) {
                        left = 10;
                    }
                    if (left + tooltipRect.width > window.innerWidth) {
                        left = window.innerWidth - tooltipRect.width - 10;
                    }

                    activeTooltip.style.top = `${top}px`;
                    activeTooltip.style.left = `${left}px`;
        
                    // Show the tooltip
                    setTimeout(() => activeTooltip.classList.add('active'), 10);
                });
        
                icon.addEventListener('mouseleave', () => {
                    if (activeTooltip) {
                        activeTooltip.classList.remove('active');
                        // Remove from DOM after transition
                        setTimeout(() => {
                            if (activeTooltip && !activeTooltip.classList.contains('active')) {
                                activeTooltip.remove();
                                activeTooltip = null;
                            }
                        }, 200);
                    }
                });
            });
        }

        async function fetchComparison() {
            const usernames = [
                document.getElementById('compare-user-1').value.trim(),
                document.getElementById('compare-user-2').value.trim()
            ].filter(Boolean).map(u => u.replace('@', ''));

            if (usernames.length < 2) {
                DOMElements.comparisonPopupContent.innerHTML = `<p class="text-red-500 p-4 text-center">Please enter two usernames to compare.</p>`;
                return;
            }

            const promises = usernames.map(u => fetchProfile(u).catch(e => ({error: true, username: u})));
            const allData = await Promise.all(promises);

            const validProfiles = allData.filter(d => !d.error);

            if (validProfiles.length < 2) {
                DOMElements.comparisonPopupContent.innerHTML = `<p class="text-red-500 p-4 text-center">Could not fetch enough valid profiles for comparison. Please check the usernames.</p>`;
                return;
            }

            validProfiles.forEach(data => {
                const { user, stats } = data;
                const followers = stats.followerCount || 0;
                const likes = stats.heartCount || 0;
                const videos = Math.max(1, stats.videoCount || 1);
                
                data.advanced = {
                    engagementRate: followers > 0 ? (((likes + stats.commentCount + stats.shareCount) / videos) / followers) * 100 : 0,
                    accountScore: calculateAccountScore(stats),
                    viralityIndex: calculateViralityIndex(stats),
                    optimizationScore: calculateProfileOptimization(user).score,
                    loyaltyRatio: followers > 0 ? (likes / followers) : 0,
                    avgLikes: videos > 0 ? (likes / videos) : 0,
                    ffRatio: (followers / (stats.followingCount || 1)),
                };
            });

            const p1 = validProfiles[0];
            const p2 = validProfiles[1];

            const starRating1 = (p1.advanced.accountScore / 100) * 5;
            const starRating2 = (p2.advanced.accountScore / 100) * 5;

            const popupHeaderHTML = `
                <button class="popup-close-btn" id="close-comparison-popup-btn">×</button>
                <header class="comparison-header-redesigned">
                    <div class="header-user-profile-new user-1">
                        <img src="${p1.user.avatarThumb}" alt="${p1.user.nickname} Avatar" class="header-avatar-new">
                        <div class="header-user-info">
                            <h3 class="header-nickname-new">${p1.user.nickname}</h3>
                            <div class="header-stars">${renderStars(starRating1)}</div>
                            <p class="header-username-new">@${p1.user.uniqueId}</p>
                        </div>
                         <div class="header-score-badge">
                            <div class="score-value">${p1.advanced.accountScore}</div>
                            <div class="score-label">Score</div>
                        </div>
                    </div>
                    <div class="header-separator"></div>
                    <div class="header-user-profile-new user-2">
                        <div class="header-score-badge">
                            <div class="score-value">${p2.advanced.accountScore}</div>
                            <div class="score-label">Score</div>
                        </div>
                        <div class="header-user-info">
                            <h3 class="header-nickname-new">${p2.user.nickname}</h3>
                             <div class="header-stars">${renderStars(starRating2)}</div>
                            <p class="header-username-new">@${p2.user.uniqueId}</p>
                        </div>
                        <img src="${p2.user.avatarThumb}" alt="${p2.user.nickname} Avatar" class="header-avatar-new">
                    </div>
                </header>
            `;

            const summaryHTML = `<div id="comparison-ai-summary"><p>${generateComparisonSummary(validProfiles)}</p></div>`;

            const metricsConfig = [
                { key: 'followerCount', label: 'Followers', baseKey: 'stats', format: formatNumber, tooltip: { title: 'Followers', desc: 'The total number of accounts following the user. This metric indicates the potential audience reach.', tips: ['Post consistently to attract new followers.', 'Use trending sounds and hashtags to get discovered.'] } },
                { key: 'heartCount', label: 'Total Likes', baseKey: 'stats', format: formatNumber, tooltip: { title: 'Total Likes', desc: 'The cumulative number of likes across all videos. A strong indicator of overall content appeal and account history.', tips: ['Keep producing high-quality content that resonates.', 'High likes improve your account\'s authority over time.'] } },
                { key: 'videoCount', label: 'Total Videos', baseKey: 'stats', format: formatNumber, tooltip: { title: 'Total Videos', desc: 'The total number of videos posted. Measures content output and consistency over the account\'s lifetime.', tips: ['Aim for a consistent posting schedule (e.g., 3-5 times a week).', 'More videos provide more data on what works for your audience.'] } },
                { key: 'engagementRate', label: 'Engagement Rate', format: (v) => `${v.toFixed(2)}%`, tooltip: { title: 'Engagement Rate', desc: 'The percentage of followers that interact with content. High engagement is crucial for community building and the algorithm.', tips: ['Ask questions in your video captions or on-screen text.', 'Reply to comments quickly to encourage more interaction.'] } },
                { key: 'avgLikes', label: 'Avg. Likes / Video', format: formatNumber, tooltip: { title: 'Average Likes per Video', desc: 'This shows how individual pieces of content typically perform. A high average indicates consistent content quality.', tips: ['Analyze your top-performing videos and replicate their format.', 'Aim for a hook that grabs attention in the first 2 seconds.'] } },
                { key: 'ffRatio', label: 'Follower/Following Ratio', format: (v) => v.toFixed(1), tooltip: { title: 'Follower/Following Ratio', desc: 'Compares followers to the number of accounts followed. A high ratio (>5) is a strong indicator of influence and authenticity.', tips: ['Avoid mass-following tactics to grow your account.', 'A healthy ratio is attractive to potential brand partners.'] } },
                { key: 'viralityIndex', label: 'Virality Index', format: (v) => v.toFixed(1), tooltip: { title: 'Virality Index', desc: 'Measures how effectively content reaches the "For You" page beyond existing followers. A higher score means better viral potential.', tips: ['Master the first 3 seconds of your video with a strong hook.', 'Use trending audio, but add your own creative spin.'] } },
                { key: 'optimizationScore', label: 'Profile Optimization', format: (v) => `${v}/100`, tooltip: { title: 'Profile Optimization', desc: 'Scores the completeness and effectiveness of the profile bio, link, and call-to-action for converting visitors to followers.', tips: ['Include a clear value proposition in your bio.', 'Always have a link-in-bio, even if it\'s to your other socials.'] } },
                { key: 'stats', label: 'Est. Earnings/Post', isComplex: true, format: (v) => `$${formatNumber(calculateEarnings(v))}`, tooltip: { title: 'Estimated Earnings', desc: 'An estimate of what a creator could charge for one sponsored post, based on their follower count and engagement rate.', tips: ['Higher engagement rates directly lead to higher earning potential.', 'Optimize your bio with a business email for inquiries.'] } },
            ];
            
            let tableBodyHTML = '';
            metricsConfig.forEach(metric => {
                const values = validProfiles.map(p => {
                    if (metric.isComplex) return p.stats;
                    return metric.baseKey ? p.stats[metric.key] : p.advanced[metric.key];
                });
                const numericValues = values.map(v => metric.isComplex ? calculateEarnings(v) : v).filter(v => typeof v === 'number');
                const maxVal = Math.max(...numericValues);

                let row = `<tr><td>
                    <div class="metric-title-cell">
                        <span>${metric.label}</span>
                         <span class="opt-tooltip ml-2">
                            <i class="fas fa-question-circle opt-tooltip-icon"></i>
                            <span class="opt-tooltip-text">${generateMetricTooltipHTML(metric.tooltip)}</span>
                        </span>
                    </div>
                </td>`;

                validProfiles.forEach((p, index) => {
                    const value = values[index];
                    const numericValue = numericValues[index];
                    const displayValue = metric.format ? metric.format(value) : value;
                    const isWinner = numericValues.length > 1 && numericValue === maxVal && maxVal > 0;
                    
                    row += `<td class="${isWinner ? 'winner-cell' : ''}"><span class="comparison-value">${displayValue}${isWinner ? '<i class="fas fa-trophy winner-icon"></i>' : ''}</span></td>`;
                });

                if(validProfiles.length === 2) {
                    const val1 = numericValues[0];
                    const val2 = numericValues[1];
                    const delta = val1 !== 0 ? ((val2 - val1) / Math.abs(val1)) * 100 : (val2 > 0 ? Infinity : 0);
                    const deltaClass = delta >= 0 ? 'delta-positive' : 'delta-negative';
                    const deltaSign = delta >= 0 ? '+' : '';
                    const deltaDisplay = isFinite(delta) ? `${deltaSign}${delta.toFixed(0)}%` : '∞';
                    row += `<td><span class="delta-value ${deltaClass}">${deltaDisplay}</span></td>`;
                }
                
                tableBodyHTML += row + '</tr>';
            });
            
            const tableHTML = `<div class="comparison-table-wrapper"><table class="comparison-table"><thead><tr><th>Metric</th><th>@${p1.user.uniqueId}</th><th>@${p2.user.uniqueId}</th><th>Difference</th></tr></thead><tbody>${tableBodyHTML}</tbody></table></div>`;
            const tipsHTML = generateComparisonTips(validProfiles);

            const popupBodyHTML = `<div class="comparison-popup-body">${summaryHTML}${tableHTML}${tipsHTML}</div>`;
            DOMElements.comparisonPopupContent.innerHTML = popupHeaderHTML + popupBodyHTML;
            
            document.getElementById('close-comparison-popup-btn').addEventListener('click', () => DOMElements.comparisonPopupOverlay.classList.remove('open'));
            
            // Activate the new robust tooltips after the content is rendered
            activateComparisonTooltips();
        }
        
        function switchComparisonTipTab(event, tabId) {
            const container = document.getElementById('comparison-tips-container');
            container.querySelectorAll('.tips-tab-btn').forEach(btn => btn.classList.remove('active-tab'));
            container.querySelectorAll('.tips-tab-panel').forEach(panel => panel.classList.remove('active-panel'));
            event.currentTarget.classList.add('active-tab');
            document.getElementById(tabId).classList.add('active-panel');
        }

        function generateComparisonTips(profiles) {
            if (profiles.length < 2) return '';

            const p1 = profiles[0];
            const p2 = profiles[1];
            const p1_tips = [];
            const p2_tips = [];
            const general_tips = [];

            // Engagement Tips
            if (p1.advanced.engagementRate > p2.advanced.engagementRate) {
                p2_tips.push(`Study <strong>@${p1.user.uniqueId}'s</strong> comment sections to see how they drive conversations and build community.`);
                p1_tips.push(`Your engagement is a key strength. Double down by hosting Q&A sessions or creating more interactive content.`);
            } else {
                p1_tips.push(`Your engagement is lower. Analyze <strong>@${p2.user.uniqueId}'s</strong> use of questions and CTAs to boost interaction.`);
                p2_tips.push(`Your strong engagement is a major asset. Continue fostering your community by replying to comments and creating duettable content.`);
            }
            if (p1.advanced.viralityIndex > p2.advanced.viralityIndex) {
                p2_tips.push(`To improve virality, analyze the hooks and trending audio used by <strong>@${p1.user.uniqueId}</strong> to capture attention faster.`);
                 p1_tips.push(`You excel at reaching the FYP. Identify the formats of your most viral videos and create variations of them.`);
            } else {
                p1_tips.push(`Your content could reach more people. Look at <strong>@${p2.user.uniqueId}'s</strong> most-viewed videos for viral format ideas.`);
                 p2_tips.push(`Your viral strategy is effective. Ensure you are converting viral viewers into long-term followers with a clear profile value proposition.`);
            }
            if (p1.advanced.loyaltyRatio > p2.advanced.loyaltyRatio) {
                 p2_tips.push(`<strong>@${p1.user.uniqueId}</strong> has a more loyal fanbase. Consider creating content series or a stronger personal brand to increase loyalty.`);
                 p1_tips.push(`Your high audience loyalty is a superpower. Monetize this by offering exclusive content or products to your dedicated fans.`);
            } else {
                 p1_tips.push(`To build a more loyal audience like <strong>@${p2.user.uniqueId}</strong>, focus on creating a consistent content theme or a recurring character.`);
                 p2_tips.push(`Your audience is very loyal. Leverage this by creating longer-form content or a newsletter to deepen the connection.`);
            }
             if (p1.advanced.optimizationScore < 80) {
                 p1_tips.push(`Your profile is not fully optimized. Add a clearer call-to-action and a professional email to your bio to attract more brand deals.`);
            }
             if (p2.stats.videoCount > p1.stats.videoCount * 1.5) {
                 p1_tips.push(`<strong>@${p2.user.uniqueId}</strong> posts more frequently. Try increasing your posting cadence to 3-5 times per week to accelerate growth.`);
            }
             if (p2.advanced.optimizationScore < 80) {
                 p2_tips.push(`Your bio is missing key elements. Add a descriptive sentence about your content and a link to your other platforms to improve your score.`);
            }
             if (p1.stats.videoCount > p2.stats.videoCount * 1.5) {
                 p2_tips.push(`Your content output is lower than <strong>@${p1.user.uniqueId}'s</strong>. Consider batch-creating content to maintain a more consistent schedule.`);
            }
            
            general_tips.push('<strong>Cross-Platform Promotion:</strong> Ensure you are promoting your TikTok on other platforms like Instagram or YouTube to drive external traffic.');
            general_tips.push('<strong>Analyze Posting Times:</strong> Use TikTok Analytics to identify when your followers are most active and schedule your posts for those peak times.');
            general_tips.push('<strong>Hook Variation:</strong> Don\'t use the same type of hook for every video. Experiment with questions, surprising statements, and trending formats.');
            general_tips.push('<strong>Bio Call-to-Action:</strong> Have a clear, single call-to-action (CTA) in your bio. Tell visitors exactly what you want them to do next (e.g., "Shop my looks," "Get my free guide").');
            general_tips.push('<strong>Engage with your Niche:</strong> Spend 15 minutes a day genuinely commenting on other videos in your niche. This increases your visibility to relevant audiences.');

            return `
                <div id="comparison-tips-container" class="tips-tab-container">
                    <h4><i class="fas fa-brain"></i>AI-Powered Tips</h4>
                    <div class="tips-tab-nav">
                        <button class="tips-tab-btn active-tab" onclick="switchComparisonTipTab(event, 'tips-p1')">For @${p1.user.uniqueId}</button>
                        <button class="tips-tab-btn" onclick="switchComparisonTipTab(event, 'tips-p2')">For @${p2.user.uniqueId}</button>
                        <button class="tips-tab-btn" onclick="switchComparisonTipTab(event, 'tips-general')">General</button>
                    </div>
                    <div class="tips-tab-content">
                        <div id="tips-p1" class="tips-tab-panel active-panel">
                             <ul>${p1_tips.slice(0, 5).map(tip => `<li><i class="fas fa-lightbulb"></i><span>${tip}</span></li>`).join('')}</ul>
                        </div>
                        <div id="tips-p2" class="tips-tab-panel">
                             <ul>${p2_tips.slice(0, 5).map(tip => `<li><i class="fas fa-lightbulb"></i><span>${tip}</span></li>`).join('')}</ul>
                        </div>
                        <div id="tips-general" class="tips-tab-panel">
                            <ul>${general_tips.map(tip => `<li><i class="fas fa-lightbulb"></i><span>${tip}</span></li>`).join('')}</ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateOpportunityScore(stats) {
            const followers = stats.followerCount || 1;
            const er = (stats.heartCount / Math.max(1, stats.videoCount)) / followers * 100;
            const virality = calculateViralityIndex(stats);
            const score = (er * 2 + virality / 5) / (Math.log10(followers + 1));
            return Math.min(10, score / 3);
        }
        
        function loadUserToMain(username) {
            DOMElements.usernameInput.value = username;
            DOMElements.fetchBtn.click();
            DOMElements.comparisonPopupOverlay.classList.remove('open');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function generateComparisonSummary(profiles) {
            if (profiles.length < 2) return '';
            const sortedByScore = [...profiles].sort((a,b) => b.advanced.accountScore - a.advanced.accountScore);
            const winner = sortedByScore[0];
            const runnerUp = sortedByScore[1];

            let summary = `In this head-to-head, <strong>@${winner.user.uniqueId}</strong> emerges as the top performer with a higher overall Account Score. `;
            if(winner.advanced.engagementRate > runnerUp.advanced.engagementRate) {
                summary += `Their key advantage lies in a superior engagement rate of <strong>${winner.advanced.engagementRate.toFixed(2)}%</strong>, indicating a highly active and responsive community. `;
            } else {
                 summary += `While <strong>@${runnerUp.user.uniqueId}</strong> shows stronger engagement, <strong>@${winner.user.uniqueId}</strong> compensates with better overall metrics. `;
            }
            if(winner.advanced.viralityIndex > runnerUp.advanced.viralityIndex) {
                 summary += `Furthermore, their higher Virality Index suggests their content is more effective at reaching new audiences on the For You page.`;
            } else {
                 summary += `An area for improvement for <strong>@${winner.user.uniqueId}</strong> could be increasing content virality to match the reach of <strong>@${runnerUp.user.uniqueId}</strong>.`
            }
            return summary;
        }
        
        function calculateAccountScore(stats) {
            const followers = stats.followerCount || 0;
            const likes = stats.heartCount || 0;
            const videos = Math.max(1, stats.videoCount || 1);
            const following = stats.followingCount || 1;
            const engagementRate = followers > 0 ? (((likes / videos) / followers) * 100) : 0;
            const engagementScore = Math.min(engagementRate / 5, 1) * 50;
            const followerScore = Math.min(Math.log10(followers + 1) / 7, 1) * 30;
            const ffRatio = followers / following;
            const healthScore = Math.min(ffRatio / 10, 1) * 20;
            const totalScore = Math.round(engagementScore + followerScore + healthScore);
            return Math.min(totalScore, 100);
        }

        function calculateProfileOptimization(user) {
            let score = 0;
            let checklist = [];
            const checkIcon = '<i class="fas fa-check-circle text-green-500 mr-2"></i>';
            const xIcon = '<i class="fas fa-times-circle text-red-500 mr-2"></i>';

            if (user.signature && user.signature.length > 20) {
                score += 25;
                checklist.push(`<li>${checkIcon}Detailed Bio</li>`);
            } else {
                checklist.push(`<li>${xIcon}Bio is too short</li>`);
            }

            if (/link in bio|shop|dm for|collab|email/i.test(user.signature)) {
                score += 40;
                checklist.push(`<li>${checkIcon}Bio includes a CTA</li>`);
            } else {
                checklist.push(`<li>${xIcon}No Call-to-Action in Bio</li>`);
            }
            
            if (user.bioLink?.link) {
                score += 35;
                 checklist.push(`<li>${checkIcon}External Link Added</li>`);
            } else {
                checklist.push(`<li>${xIcon}No External Link</li>`);
            }

            return { score: Math.round(score), checklist: checklist };
        }
        
        function calculateViralityIndex(stats) {
            const followers = stats.followerCount || 1;
            const avgLikes = stats.heartCount / Math.max(1, stats.videoCount);
            return (avgLikes / (followers / 1000));
        }

        function renderAccountAnalysis(stats) {
            const score = calculateAccountScore(stats);
            const scoreEl = document.getElementById('account-score-value');
            scoreEl.textContent = score;

            let description = "A promising account with room to grow.";
            if (score > 90) description = "Exceptional! A top-tier, high-performing account.";
            else if (score > 75) description = "Excellent! This account shows strong performance.";
            else if (score > 50) description = "Solid performance with good potential.";
            document.getElementById('account-score-description').textContent = description;
            
            const followers = stats.followerCount || 0;
            const likes = stats.heartCount || 0;
            const videos = Math.max(1, stats.videoCount || 1);
            const engagementRate = followers > 0 ? (((likes / videos) / followers) * 100) : 0;
            const ffRatio = followers / (stats.followingCount || 1);
            
            const recommendations = [];
            if (score > 85) {
                recommendations.push({text: "Your account is performing exceptionally. Focus on monetization and building a strong community.", icon: 'fa-check-circle'});
            }
            if(engagementRate > 3.5){
                recommendations.push({text: `Your engagement rate of ${engagementRate.toFixed(2)}% is excellent. Keep creating content your audience loves.`, icon: 'fa-check-circle'});
            } else {
                 recommendations.push({text: `Boost your engagement rate. Use stronger hooks, ask questions, and reply to comments to build a community.`, icon: 'fa-lightbulb'});
            }

            if(ffRatio > 5){
                recommendations.push({text: "Your high Follower/Following ratio is a strong indicator of influence.", icon: 'fa-check-circle'});
            } else if (ffRatio < 1.2) {
                 recommendations.push({text: "Consider reviewing your 'following' list. A higher follower-to-following ratio can improve perceived authority.", icon: 'fa-lightbulb'});
            }

            if (videos < 50 && followers > 1000) {
                 recommendations.push({text: "You have good traction. Increase posting frequency to 3-5 times a week to accelerate growth.", icon: 'fa-lightbulb'});
            } else {
                 recommendations.push({text: "Consistency is key. Maintain a regular posting schedule to keep your audience engaged.", icon: 'fa-check-circle'});
            }

            const listEl = document.getElementById('recommendation-list');
            listEl.innerHTML = recommendations.slice(0, 3).map(rec => 
                `<li><i class="fas ${rec.icon}"></i><span>${rec.text}</span></li>`
            ).join('');
        }

        function renderGrowthProjection(stats, monthlyGrowthRate) {
            if (!stats) return;

            const currentFollowers = stats.followerCount;
            const months = ['Current', '+1 Mo', '+2 Mo', '+3 Mo', '+4 Mo', '+5 Mo', '+6 Mo'];
            const projectedFollowers = [currentFollowers];
            const projectedEarnings = [calculateEarnings(stats)];

            let lastFollowerCount = currentFollowers;
            for (let i = 0; i < 6; i++) {
                const newFollowerCount = Math.round(lastFollowerCount * (1 + monthlyGrowthRate / 100));
                projectedFollowers.push(newFollowerCount);
                const futureStats = { ...stats, followerCount: newFollowerCount };
                projectedEarnings.push(calculateEarnings(futureStats));
                lastFollowerCount = newFollowerCount;
            }

            const style = getComputedStyle(document.body);
            const tiktokPink = style.getPropertyValue('--tiktok-pink').trim();
            const tiktokCyan = style.getPropertyValue('--tiktok-cyan').trim();
            const textColor = style.getPropertyValue('--text-primary').trim();
            const gridColor = style.getPropertyValue('--border-color').trim();

            const followerTrace = { x: months, y: projectedFollowers, name: 'Followers', type: 'scatter', mode: 'lines+markers', marker: { color: tiktokPink, size: 8 }, line: { width: 3 }, hovertemplate: '<b>%{x}</b><br>Followers: %{y:,}<extra></extra>' };
            const earningsTrace = { x: months, y: projectedEarnings, name: 'Est. Earnings/Post', type: 'scatter', mode: 'lines+markers', yaxis: 'y2', marker: { color: tiktokCyan, size: 8, line: { color: 'white', width: 1 }}, line: { width: 3, dash: 'dot' }, hovertemplate: 'Earnings: $%{y:,.2f}<extra></extra>' };
            const layout = { title: { text: `6-Month Forecast at ${monthlyGrowthRate}% Monthly Growth`, font: { size: 16 } }, font: { family: 'Inter, sans-serif', color: textColor }, paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', margin: { t: 50, r: 60, b: 50, l: 70 }, xaxis: { gridcolor: 'transparent' }, yaxis: { title: 'Projected Followers', gridcolor: gridColor, tickformat: ',.0s' }, yaxis2: { title: 'Projected Earnings/Post ($)', overlaying: 'y', side: 'right', showgrid: false, zeroline: false, tickformat: '$,.0f' }, legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.2, yanchor: 'top' }, hovermode: 'x unified' };

            Plotly.newPlot('projection-chart', [followerTrace, earningsTrace], layout, { responsive: true, displaylogo: false });
        }
        
        function getCreatorTier(followers) {
            if (followers >= 1000000) return 'Macro';
            if (followers >= 100000) return 'Mid-Tier';
            if (followers >= 10000) return 'Micro';
            return 'Nano';
        }

        function runOptimizationAnalysis() {
            if (!lastProfileStats) {
                alert("Please analyze a profile before running optimization.");
                return;
            }
            const { user, stats } = lastProfileStats;
            const container = document.getElementById('optimization-steps-container');
            const summaryEl = document.getElementById('optimization-summary');
            container.innerHTML = '';
            summaryEl.style.display = 'none';

            document.getElementById('optimize-popup-overlay').classList.add('open');
            
            const tier = getCreatorTier(stats.followerCount);
            let results = {};

            const analysisSteps = [
                { id: 'engagement', name: `Analyzing Engagement (vs. ${tier}-Creators)...`, delay: 500, eval: () => evaluateEngagement(stats, tier) },
                { id: 'virality', name: "Assessing Content Virality...", delay: 700, eval: () => evaluateVirality(stats, tier) },
                { id: 'loyalty', name: "Measuring Audience Loyalty...", delay: 700, eval: () => evaluateLoyalty(stats, tier) },
                { id: 'health', name: "Checking Profile Health...", delay: 700, eval: () => evaluateProfileHealth(stats) },
                { id: 'bio', name: "Optimizing Bio Content...", delay: 700, eval: () => evaluateBio(user) },
                { id: 'username', name: "Evaluating Username Quality...", delay: 700, eval: () => evaluateUsername(user) },
                { id: 'consistency', name: "Evaluating Posting Consistency...", delay: 700, eval: () => evaluateConsistency(stats) }
            ];

            let cumulativeDelay = 0;
            analysisSteps.forEach((step, index) => {
                cumulativeDelay += step.delay;
                setTimeout(() => {
                    const stepId = `step-${index}`;
                    const stepEl = document.createElement('div');
                    stepEl.id = stepId;
                    stepEl.className = 'optimization-step';
                    const tooltipHTML = `
                        <span class="opt-tooltip">
                            <i class="fas fa-question-circle opt-tooltip-icon"></i>
                            <span class="opt-tooltip-text">${getTooltipContent(step.id)}</span>
                        </span>`;

                    stepEl.innerHTML = `
                        <div class="flex items-center">
                            ${tooltipHTML}
                            <span class="optimization-step-text">${step.name}</span>
                        </div>
                        <span class="optimization-step-result"><i class="fas fa-spinner fa-spin"></i></span>
                    `;
                    container.appendChild(stepEl);
                    
                    const tooltipTrigger = stepEl.querySelector('.opt-tooltip');
                    if (tooltipTrigger) {
                        tooltipTrigger.addEventListener('mouseenter', (e) => {
                            const trigger = e.currentTarget;
                            const tooltipText = trigger.querySelector('.opt-tooltip-text');
                            const popupContent = trigger.closest('.popup-content');
                            if (!tooltipText || !popupContent) return;

                            const triggerRect = trigger.getBoundingClientRect();
                            const popupRect = popupContent.getBoundingClientRect();
                            
                            const spaceAbove = triggerRect.top - popupRect.top;
                            
                            if (spaceAbove < (tooltipText.offsetHeight + 15)) {
                                trigger.classList.add('opens-down');
                            }
                        });
                        tooltipTrigger.addEventListener('mouseleave', (e) => {
                            e.currentTarget.classList.remove('opens-down');
                        });
                    }

                    setTimeout(() => stepEl.classList.add('visible'), 50);

                    setTimeout(() => {
                        const result = step.eval();
                        results[step.id] = result;
                        const resultEl = document.querySelector(`#${stepId} .optimization-step-result`);
                        resultEl.innerHTML = `<span class="status-text ${result.status}">${result.message} <i class="fas ${result.icon}"></i></span>`;
                    }, 1500);

                }, cumulativeDelay);
            });
            
            setTimeout(() => {
                const finalScore = Math.round(Object.values(results).reduce((acc, r) => acc + r.score, 0) / analysisSteps.length);
                document.getElementById('optimization-final-score').textContent = finalScore;
                
                const scoreIconEl = document.getElementById('final-score-icon');
                if(finalScore > 80) scoreIconEl.className = 'fas fa-rocket text-4xl text-tiktok-pink';
                else if (finalScore > 60) scoreIconEl.className = 'fas fa-star text-4xl text-yellow-500';
                else scoreIconEl.className = 'fas fa-tools text-4xl text-gray-500';

                document.getElementById('optimization-final-hint').innerHTML = generateProTip(results);
                
                const benchmarkER = getEngagementBenchmarks(tier).excellent;
                const currentEarnings = calculateEarnings(stats);
                const potentialEarnings = calculateEarnings(stats, benchmarkER);
                document.getElementById('untapped-potential-text').innerHTML = `With optimization, your est. earnings could increase from <strong>$${currentEarnings.toFixed(2)}/post</strong> to <strong>$${potentialEarnings.toFixed(2)}/post</strong>.`;
                
                const radarData = [results.engagement.score, results.virality.score, results.loyalty.score, results.bio.score, results.consistency.score];
                summaryEl.style.display = 'block';
                renderOptimizationRadar(radarData);
            }, cumulativeDelay + 2000);
        }

        const benchmarks = {
            engagement: { Nano: { good: 4, excellent: 8 }, Micro: { good: 2, excellent: 5 }, 'Mid-Tier': { good: 1.5, excellent: 3.5 }, Macro: { good: 1, excellent: 2 } },
            virality: { Nano: { good: 50, excellent: 100 }, Micro: { good: 30, excellent: 70 }, 'Mid-Tier': { good: 20, excellent: 40 }, Macro: { good: 10, excellent: 25 } },
            loyalty: { Nano: { good: 10, excellent: 25 }, Micro: { good: 8, excellent: 20 }, 'Mid-Tier': { good: 5, excellent: 15 }, Macro: { good: 3, excellent: 10 } }
        };
        const getEngagementBenchmarks = (tier) => benchmarks.engagement[tier];
        const getViralityBenchmarks = (tier) => benchmarks.virality[tier];
        const getLoyaltyBenchmarks = (tier) => benchmarks.loyalty[tier];

        function evaluateEngagement(stats, tier) {
            const er = parseFloat(document.getElementById('insight-engagement').textContent) || 0;
            const { good, excellent } = getEngagementBenchmarks(tier);
            if (er >= excellent) return { score: 100, status: 'status-good', message: `Excellent (${er.toFixed(1)}%)`, icon: 'fa-check-circle' };
            if (er >= good) return { score: 75, status: 'status-average', message: `Good (${er.toFixed(1)}%)`, icon: 'fa-lightbulb' };
            return { score: 30, status: 'status-bad', message: `Low (${er.toFixed(1)}%)`, icon: 'fa-exclamation-triangle' };
        }

        function evaluateVirality(stats, tier) {
            const vi = calculateViralityIndex(stats);
            const { good, excellent } = getViralityBenchmarks(tier);
            if (vi >= excellent) return { score: 100, status: 'status-good', message: `High Index (${vi.toFixed(0)})`, icon: 'fa-check-circle' };
            if (vi >= good) return { score: 70, status: 'status-average', message: `Moderate Index (${vi.toFixed(0)})`, icon: 'fa-lightbulb' };
            return { score: 30, status: 'status-bad', message: `Low Index (${vi.toFixed(0)})`, icon: 'fa-exclamation-triangle' };
        }
        
        function evaluateLoyalty(stats, tier) {
            const lfRatio = (stats.heartCount || 0) / (stats.followerCount || 1);
            const { good, excellent } = getLoyaltyBenchmarks(tier);
             if (lfRatio >= excellent) return { score: 100, status: 'status-good', message: `Super-fans (${lfRatio.toFixed(1)})`, icon: 'fa-check-circle' };
            if (lfRatio >= good) return { score: 75, status: 'status-average', message: `Loyal (${lfRatio.toFixed(1)})`, icon: 'fa-lightbulb' };
            return { score: 35, status: 'status-bad', message: `Passive (${lfRatio.toFixed(1)})`, icon: 'fa-exclamation-triangle' };
        }

        function evaluateProfileHealth(stats) {
            const ffRatio = (stats.followerCount || 1) / (stats.followingCount || 1);
            if (ffRatio > 5) return { score: 100, status: 'status-good', message: 'Strong Ratio', icon: 'fa-check-circle' };
            if (ffRatio > 1.5) return { score: 75, status: 'status-average', message: 'Healthy Ratio', icon: 'fa-lightbulb' };
            return { score: 40, status: 'status-bad', message: 'Weak Ratio', icon: 'fa-exclamation-triangle' };
        }

        function evaluateBio(user) {
            const { score } = calculateProfileOptimization(user);
            if (score > 70) return { score: 100, status: 'status-good', message: 'Fully Optimized', icon: 'fa-check-circle' };
            if (score > 40) return { score: 60, status: 'status-average', message: 'Partially Optimized', icon: 'fa-lightbulb' };
            return { score: 25, status: 'status-bad', message: 'Needs Work', icon: 'fa-exclamation-triangle' };
        }

        function evaluateUsername(user) {
            const username = user.uniqueId;
            const hasNumbers = /\d{3,}/.test(username);
            const hasUnderscores = /_/.test(username);
            const isLong = username.length > 15;
            if (!hasNumbers && !hasUnderscores && !isLong) return { score: 100, status: 'status-good', message: 'Clean & Memorable', icon: 'fa-check-circle' };
            if (isLong || hasUnderscores) return { score: 60, status: 'status-average', message: 'Could be simpler', icon: 'fa-lightbulb' };
            return { score: 30, status: 'status-bad', message: 'Hard to Remember', icon: 'fa-exclamation-triangle' };
        }
        
        function evaluateConsistency(stats) {
            if (stats.videoCount > 100) return { score: 95, status: 'status-good', message: 'Highly Consistent', icon: 'fa-check-circle' };
            if (stats.videoCount > 20) return { score: 70, status: 'status-average', message: 'Good Consistency', icon: 'fa-lightbulb' };
            return { score: 40, status: 'status-bad', message: 'New/Infrequent', icon: 'fa-exclamation-triangle' };
        }
        
        function downloadOptimizationReport() {
            const reportArea = document.getElementById('optimize-popup-content');
            const downloadBtn = document.getElementById('download-optimization-report-btn');
            const username = lastProfileStats.user.uniqueId || 'report';
            
            downloadBtn.style.display = 'none';
            
            html2canvas(reportArea, { scale: 2, backgroundColor: '#FFFFFF' }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png', 1.0);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`optimization-report-${username}.pdf`);
                downloadBtn.style.display = 'inline-block';
            }).catch(err => {
                 console.error("PDF Generation Failed:", err);
                 downloadBtn.style.display = 'inline-block';
            });
        }
        
        function renderOptimizationRadar(data) {
            const ctx = document.getElementById('optimization-radar-chart').getContext('2d');
            if (optimizationRadarChart) {
                optimizationRadarChart.destroy();
            }
            optimizationRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Engagement', 'Virality', 'Loyalty', 'Profile', 'Consistency'],
                    datasets: [{
                        label: 'Optimization Score',
                        data: data,
                        backgroundColor: 'rgba(254, 44, 85, 0.2)',
                        borderColor: 'rgba(254, 44, 85, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(254, 44, 85, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(254, 44, 85, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: '#E2E8F0' },
                            grid: { color: '#E2E8F0' },
                            pointLabels: { font: { size: 12, weight: '500' }, color: '#4A5568' },
                            ticks: { backdropColor: 'white', color: '#64748B', stepSize: 25 },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function generateProTip(results) {
            if (results.engagement.score < 50 && results.virality.score > 70) {
                return "<strong>Pro-Tip:</strong> You excel at going viral! To build a loyal base, focus on creating series and engaging directly with your comments.";
            }
            if (results.engagement.score > 70 && results.virality.score < 50) {
                return "<strong>Pro-Tip:</strong> Your community is highly engaged! To reach new audiences, incorporate more trending sounds and broader hashtags in your content.";
            }
            if (results.bio.score < 50 && results.engagement.score > 70) {
                return "<strong>Pro-Tip:</strong> Your content is fantastic, but your bio is holding you back. Add a clear Call-to-Action and a link to convert your views into followers or customers.";
            }
            if(results.loyalty.score < 50 && results.engagement.score > 70) {
                 return "<strong>Pro-Tip:</strong> Viewers love your individual videos, but aren't becoming long-term fans. Create a content series or use a stronger personal brand to build loyalty.";
            }
            if (results.health.score < 50) {
                return "<strong>Pro-Tip:</strong> To increase your account's authority, consider unfollowing inactive accounts to improve your Follower/Following ratio."
            }
            return "<strong>Pro-Tip:</strong> Your account has a solid foundation. For maximum growth, focus on improving your lowest-scoring areas shown in the chart."
        }

        function getTooltipContent(stepId) {
            const tooltips = {
                engagement: {
                    title: 'Engagement Rate',
                    desc: 'Measures how actively your followers interact with your content. A high rate is crucial for community building and algorithm favor.',
                    tips: [ 'End videos with a question to spark discussion.', 'Reply to comments within the first hour of posting.', 'Run polls or Q&As in your comments section.' ]
                },
                virality: {
                    title: 'Content Virality Index',
                    desc: 'This score shows how well your content reaches new audiences beyond your existing followers on the For You page.',
                    tips: [ 'Use trending audio, but add your own unique twist.', 'Create highly shareable content like tutorials or relatable humor.', 'Collaborate with other creators to cross-promote audiences.' ]
                },
                health: {
                    title: 'Profile Health',
                    desc: 'Assesses technical factors like your Follower-to-Following ratio. A healthy ratio signals authority and authenticity.',
                    tips: [ 'Regularly unfollow accounts that are inactive or don\'t align with your niche.', 'Avoid mass-following tactics; focus on organic growth.', 'Engage with other accounts genuinely, not just for a follow-back.' ]
                },
                bio: {
                    title: 'Bio Optimization',
                    desc: 'Your bio is your digital business card. It needs to quickly tell new visitors who you are and what you do.',
                    tips: [ 'Clearly state your niche or value proposition in the first line.', 'Include a strong Call-to-Action (e.g., "Shop Now," "Follow for...").', 'Use the link-in-bio for your most important external page.' ]
                },
                consistency: {
                    title: 'Posting Consistency',
                    desc: 'This evaluates how frequently you post content. The TikTok algorithm rewards regular, predictable activity.',
                    tips: [ 'Aim for 3-5 high-quality videos per week.', 'Batch-create your content on one day to have videos ready for the week.', 'Post when your audience is most active (check your TikTok analytics).' ]
                },
                 loyalty: {
                    title: 'Audience Loyalty',
                    desc: 'Measures the long-term engagement of your followers across all your content (Total Likes / Followers). High loyalty means a strong, dedicated fanbase.',
                    tips: [ 'Create a content series that makes viewers want to come back for more.', 'Develop inside jokes or recurring themes that build community.', 'Show your personality to create a stronger, more personal connection.' ]
                },
                username: {
                    title: 'Username Quality',
                    desc: 'A clean, memorable username is crucial for branding and makes it easy for others to find and tag you.',
                    tips: [ 'Avoid long strings of random numbers (e.g., user1847392).', 'Try to keep it short, simple, and easy to spell.', 'If possible, make it consistent with your other social media handles.' ]
                }
            };
            const content = tooltips[stepId];
            if (!content) return '';
            return `
                <h5>${content.title}</h5>
                <p>${content.desc}</p>
                <ul>
                    ${content.tips.map(tip => `<li><i class="fas fa-lightbulb"></i><span>${tip}</span></li>`).join('')}
                </ul>
            `;
        }
        
        function calculateAccountWorth(stats) {
            const followers = stats.followerCount || 0;
            const likes = stats.heartCount || 0;
            const videos = Math.max(1, stats.videoCount || 1);
            const tier = getCreatorTier(followers);
            
            const engagementRate = followers > 0 ? (((likes / videos) / followers) * 100) : 0;
            const viralityIndex = calculateViralityIndex(stats);

            let followerValueMultiplier = 0.21;
            if (tier === 'Micro') followerValueMultiplier = 0.15;
            if (tier === 'Nano') followerValueMultiplier = 0.10;

            const followerValue = followers * followerValueMultiplier;
            const engagementValue = (likes / Math.max(1, videos)) * engagementRate * 0.10; 
            const contentValue = videos * (followers / 5000) * 0.25;
            const viralityMultiplier = 1 + (Math.log10(Math.max(1, viralityIndex)) / 2.5);
            let totalWorth = (followerValue + engagementValue + contentValue) * viralityMultiplier;

            if (stats.videoCount < 10) { totalWorth *= (stats.videoCount / 10); }
            if (lastProfileStats.user.verified) { totalWorth *= 1.5; }
            
            return Math.max(0, totalWorth);
        }

        function generateWorthSummary(stats, worth) {
            const score = calculateAccountScore(stats);
            let summaryText = '';
            
            if (score > 80) {
                summaryText = `With an exceptional account score of <strong>${score}/100</strong> and strong performance metrics, this profile demonstrates significant market value. The high engagement and influencer-level ratios contribute directly to its high estimated worth. `;
            } else if (score > 50) {
                summaryText = `This profile shows solid potential with a good account score of <strong>${score}/100</strong>. While there are areas for optimization, the foundational metrics indicate a valuable digital asset with clear pathways to increasing its worth. `;
            } else {
                summaryText = `As an emerging profile, the current estimated worth reflects its early stage. With a score of <strong>${score}/100</strong>, the key to unlocking higher value lies in boosting engagement and growing the follower base. `;
            }

            const verdict = worth > 100000 ?
                `<strong>Verdict:</strong> This is a highly valuable account, representing a prime asset for monetization and brand partnerships.` :
                `<strong>Verdict:</strong> This account has promising potential. Focusing on the growth recommendations will significantly increase its future worth.`;

            return `<p>${summaryText}${verdict}</p>`;
        }

        function openWorthPopup() {
            if (!lastProfileStats) {
                alert("Please analyze a profile first to see its worth.");
                return;
            }

            const { user, stats } = lastProfileStats;
            const worthPopupBody = DOMElements.worthPopupBody;

            worthPopupBody.innerHTML = `
                <div class="card profile-header-card">
                    <img id="worth-popup-avatar" class="profile-avatar" src="" alt="Profile Picture">
                    <div class="profile-info">
                        <h2 id="worth-popup-name" class="profile-name"></h2>
                        <div class="flex items-center justify-center sm:justify-start">
                            <a id="worth-popup-username-link" href="#" target="_blank" rel="noopener noreferrer">
                                <p id="worth-popup-username" class="profile-username"></p>
                            </a>
                            <span id="worth-popup-verified"></span>
                        </div>
                        <p id="worth-popup-bio" class="profile-bio"></p>
                    </div>
                    <div class="creator-tier-display">
                        <div id="worth-popup-tier-badge" class="tier-badge">
                            <div id="worth-popup-tier-score" class="tier-badge-score"></div>
                        </div>
                        <h4 id="worth-popup-tier-title" class="tier-title"></h4>
                        <p id="worth-popup-tier-desc" class="tier-description"></p>
                        <div id="worth-popup-tier-stars" class="tier-stars"></div>
                    </div>
                </div>
                <div class="metrics-grid">
                    <div class="metric-item"><div class="metric-icon"><i class="fas fa-users"></i></div><div><div id="worth-popup-followers" class="metric-value">0</div><div class="metric-label">Followers</div></div></div>
                    <div class="metric-item"><div class="metric-icon"><i class="fas fa-heart"></i></div><div><div id="worth-popup-likes" class="metric-value">0</div><div class="metric-label">Total Likes</div></div></div>
                    <div class="metric-item"><div class="metric-icon"><i class="fas fa-user-plus"></i></div><div><div id="worth-popup-following" class="metric-value">0</div><div class="metric-label">Following</div></div></div>
                    <div class="metric-item"><div class="metric-icon"><i class="fas fa-video"></i></div><div><div id="worth-popup-videos" class="metric-value">0</div><div class="metric-label">Videos</div></div></div>
                </div>
                <div class="account-worth-banner">
                    <h3>Account Average Worth</h3>
                    <div class="worth-value">$<span id="account-worth-value" class="odometer">0</span></div>
                    <div class="estimation-note">This Is Estimation Only</div>
                </div>
                <h3 class="text-xl font-bold text-gray-800 text-center -mb-2">Results Calculated Based On The Following Metrics</h3>
                <div class="worth-popup-grid">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-lightbulb"></i> Performance Insights</h3>
                        <div>
                            <div class="insight-item"><span class="item-label">Engagement Rate</span><span id="worth-popup-engagement" class="item-value">0%</span></div>
                            <div class="insight-item"><span class="item-label">Avg. Likes per Video</span><span id="worth-popup-avg-likes" class="item-value">0</span></div>
                            <div class="insight-item"><span class="item-label">Content Virality Index</span><span id="worth-popup-virality" class="item-value">0</span></div>
                            <div class="insight-item"><span class="item-label">Profile Optimization</span><span id="worth-popup-optimization" class="item-value">0 / 100</span></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-balance-scale"></i> Profile Health Ratios</h3>
                        <div>
                            <div class="insight-item"><span class="item-label">Follower / Following Ratio</span><span id="worth-popup-ff-ratio" class="item-value">0</span></div>
                            <div class="insight-item"><span class="item-label">Likes / Follower Ratio</span><span id="worth-popup-lf-ratio" class="item-value">0</span></div>
                            <div class="insight-item"><span class="item-label">Verified Status</span><span id="worth-popup-insight-verified" class="item-value"></span></div>
                            <div class="insight-item"><span class="item-label">Profile Bio</span><span id="worth-popup-insight-bio" class="item-value"></span></div>
                        </div>
                    </div>
                </div>
                <div class="worth-summary-section">
                    <h4 class="flex items-center gap-2"><i class="fas fa-file-alt"></i> Estimation Summary</h4>
                    <div id="worth-popup-summary"></div>
                </div>
            `;

            document.getElementById('worth-popup-avatar').src = user.avatarLarger;
            document.getElementById('worth-popup-name').textContent = user.nickname;
            document.getElementById('worth-popup-username').textContent = `@${user.uniqueId}`;
            document.getElementById('worth-popup-username-link').href = `https://www.tiktok.com/@${user.uniqueId}`;
            document.getElementById('worth-popup-bio').textContent = user.signature || "No bio available.";
            const verifiedBadgeClone = document.getElementById('verified-badge').cloneNode(true);
            document.getElementById('worth-popup-verified').replaceWith(verifiedBadgeClone);

            const tierData = calculateAndAssignTier(stats);
            document.getElementById('worth-popup-tier-badge').className = document.getElementById('tier-badge').className;
            document.getElementById('worth-popup-tier-score').textContent = `${tierData.badgeScore}/10`;
            document.getElementById('worth-popup-tier-title').textContent = tierData.title;
            document.getElementById('worth-popup-tier-desc').textContent = tierData.description;
            document.getElementById('worth-popup-tier-stars').innerHTML = renderStars(tierData.stars);

            document.getElementById('worth-popup-followers').textContent = formatNumber(stats.followerCount);
            document.getElementById('worth-popup-likes').textContent = formatNumber(stats.heartCount);
            document.getElementById('worth-popup-following').textContent = formatNumber(stats.followingCount);
            document.getElementById('worth-popup-videos').textContent = formatNumber(stats.videoCount);

            document.getElementById('worth-popup-engagement').textContent = document.getElementById('insight-engagement').textContent;
            document.getElementById('worth-popup-avg-likes').textContent = document.getElementById('insight-avg-likes').textContent;
            document.getElementById('worth-popup-virality').textContent = document.getElementById('insight-virality').textContent;
            document.getElementById('worth-popup-optimization').textContent = document.getElementById('insight-optimization-score').textContent;
            document.getElementById('worth-popup-ff-ratio').innerHTML = document.getElementById('ff-ratio').innerHTML;
            document.getElementById('worth-popup-lf-ratio').textContent = document.getElementById('lf-ratio').textContent;
            document.getElementById('worth-popup-insight-verified').innerHTML = document.getElementById('insight-verified').innerHTML;
            document.getElementById('worth-popup-insight-bio').innerHTML = document.getElementById('insight-bio-status').innerHTML;

            const finalWorth = calculateAccountWorth(stats);
            document.getElementById('worth-popup-summary').innerHTML = generateWorthSummary(stats, finalWorth);

            const accountWorthOdometer = new Odometer({ el: document.getElementById('account-worth-value'), value: 0, format: '(,ddd)', duration: 2500 });
            accountWorthOdometer.update(finalWorth);
            
            if (!confettiHasFiredForThisAnalysis) {
                setTimeout(() => {
                    const popupRect = DOMElements.worthPopupContent.getBoundingClientRect();
                    const originX = (popupRect.left + popupRect.width / 2) / window.innerWidth;
                    const originY = (popupRect.top + popupRect.height / 4) / window.innerHeight;
                    confetti({ 
                        particleCount: 200, 
                        spread: 120, 
                        origin: { x: originX, y: originY }, 
                        colors: ['#FE2C55', '#25F4EE', '#FFFFFF', '#FBBF24'],
                        zIndex: 1100 
                    });
                }, 2600);
                confettiHasFiredForThisAnalysis = true;
            }
            
            DOMElements.worthPopupOverlay.classList.add('open');
        }

        function closeWorthPopup() {
            DOMElements.worthPopupOverlay.classList.remove('open');
        }
        
        async function fetchHistory() {
            try {
                // Fetch from remote API only (global shared history)
                const response = await fetch(`${API_ENDPOINT}?action=get&t=${new Date().getTime()}`);
                console.log('History API Response Status:', response.status);

                if (!response.ok) {
                    console.error('History API Error:', response.status, response.statusText);
                    throw new Error(`Failed to fetch global history from server (${response.status}).`);
                }

                const data = await response.json();
                console.log('History API Response Data:', data);

                fullHistory = Array.isArray(data) ? data : [];
                console.log('Processed History Items:', fullHistory.length);

                historyCurrentPage = 1;
                renderHistory();
            } catch (error) {
                console.error('Global History Fetch Error:', error);
                // Show a more informative message to the user
                const statusEl = document.getElementById('history-status');
                statusEl.textContent = 'Unable to load global history. The server may be temporarily unavailable.';
                statusEl.style.display = 'block';
                fullHistory = [];
                historyCurrentPage = 1;
                renderHistory();
            }
        }

        async function convertImageToBase64(imageUrl) {
            try {
                const response = await fetch(imageUrl);
                if (!response.ok) throw new Error('Failed to fetch image');
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.warn('Failed to convert image to base64:', error);
                return null;
            }
        }

        async function saveHistory(userInfo) {
            try {
                const { user, stats } = userInfo;
                const accountScore = calculateAccountScore(stats);

                // Convert avatar to base64 to prevent expiration issues
                let avatarData = user.avatarThumb;
                try {
                    const base64Image = await convertImageToBase64(user.avatarThumb);
                    if (base64Image) {
                        avatarData = base64Image;
                        console.log('Successfully converted avatar to base64 for permanent storage');
                    }
                } catch (error) {
                    console.warn('Could not convert avatar to base64, using original URL:', error);
                }

                const historyEntry = {
                    uniqueId: user.uniqueId,
                    nickname: user.nickname,
                    avatarThumb: avatarData, // Now stores base64 or original URL
                    followerCount: stats.followerCount,
                    followingCount: stats.followingCount,
                    heartCount: stats.heartCount,
                    accountScore: accountScore,
                    timestamp: Date.now()
                };

                // Save to remote API only (global shared history)
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'save',
                        data: historyEntry
                    })
                });

                if (response.ok) {
                    console.log('Global history saved successfully with permanent avatar');
                    // Refresh the history display
                    fetchHistory();
                } else {
                    console.error('Failed to save global history:', response.status);
                    // Show user feedback about the issue
                    showHistorySaveError();
                }
            } catch (error) {
                console.error('Global History Save Error:', error);
                // Show user feedback about the issue
                showHistorySaveError();
            }
        }

        function showHistorySaveError() {
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #FE2C55;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px;">Global History Issue</div>
                <div>Unable to save to global history. Server API needs to be fixed for shared history to work.</div>
            `;

            document.body.appendChild(notification);

            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function renderHistory() {
            const historySection = document.getElementById('history-section');
            const grid = document.getElementById('history-grid');
            const pagination = document.getElementById('history-pagination');
            const statusEl = document.getElementById('history-status');
            grid.innerHTML = '';
            
            if (fullHistory.length === 0) {
                statusEl.textContent = 'No past analyses found. Analyze an account to see it here!';
                statusEl.style.display = 'block';
                pagination.style.display = 'none';
                historySection.style.display = 'block';
                return;
            }

            historySection.style.display = 'block';
            statusEl.style.display = 'none';
            
            const startIndex = (historyCurrentPage - 1) * HISTORY_ITEMS_PER_PAGE;
            const endIndex = startIndex + HISTORY_ITEMS_PER_PAGE;
            const itemsToRender = fullHistory.slice(startIndex, endIndex);

            itemsToRender.forEach(item => {
                const card = document.createElement('div');
                card.className = 'history-card';
                const starRating = (item.accountScore / 100) * 5;

                card.innerHTML = `
                    <img src="${item.avatarThumb}" alt="${item.nickname}" class="history-avatar">
                    <div class="history-name">${item.nickname}</div>
                    <div class="history-username">@${item.uniqueId}</div>
                    <div class="history-stars">${renderStars(starRating)}</div>
                    <div class="history-score">
                        Score: <span class="score-value">${item.accountScore}</span>
                    </div>
                    <button class="history-reanalyze-btn" onclick="loadUserToMain('${item.uniqueId}')">Re-Analyze</button>
                `;
                grid.appendChild(card);
            });
            
            setupPagination();
        }

        function setupPagination() {
            const pagination = document.getElementById('history-pagination');
            const pageInfo = document.getElementById('history-page-info');
            const prevBtn = document.getElementById('history-prev-btn');
            const nextBtn = document.getElementById('history-next-btn');
            
            const totalPages = Math.ceil(fullHistory.length / HISTORY_ITEMS_PER_PAGE);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            pageInfo.textContent = `Page ${historyCurrentPage} of ${totalPages}`;
            
            prevBtn.disabled = historyCurrentPage === 1;
            nextBtn.disabled = historyCurrentPage === totalPages;
        }

        window.addEventListener('load', () => {
            DOMElements.usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') fetchProfile(null, true); });
            const calculatorInputs = ['calc-followers', 'calc-views', 'calc-cpm', 'calc-sponsored', 'calc-sponsor-rate', 'calc-videos'];
            calculatorInputs.forEach(id => document.getElementById(id).addEventListener('input', calculateDetailedEarnings));
            totalEarningsOdometer = new Odometer({ el: document.getElementById('breakdown-total'), value: 0, format: '(,ddd).dd' });
            postEarningsOdometer = new Odometer({ el: document.getElementById('post-earnings-odometer'), value: 0, format: '(,ddd).dd', duration: 2000 });
            postEarningsOdometerPopup = new Odometer({ el: document.getElementById('post-earnings-odometer-popup'), value: 0, format: '(,ddd).dd', duration: 2000 });
            
            const togglePanel = () => {
                DOMElements.magicSidePanel.classList.toggle('open');
                DOMElements.magicPanelOverlay.classList.toggle('open');
            };
            DOMElements.magicNavBtn.addEventListener('click', togglePanel);
            DOMElements.magicPanelClose.addEventListener('click', togglePanel);
            DOMElements.magicPanelOverlay.addEventListener('click', togglePanel);

            const postPopupOverlay = document.getElementById('single-post-popup-overlay');
            const openPostPopup = () => { postPopupOverlay.classList.add('open'); };
            const closePostPopup = () => { postPopupOverlay.classList.remove('open'); };
            document.getElementById('close-post-popup-btn').addEventListener('click', closePostPopup);
            postPopupOverlay.addEventListener('click', e => { if(e.target === postPopupOverlay) closePostPopup(); });
            
            DOMElements.magicNavItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = item.dataset.tabid;
                    const action = item.dataset.action;

                    if (action === 'open-cta-popup') {
                        document.getElementById('cta-popup-overlay').classList.add('open');
                        togglePanel();
                        return;
                    }
                    
                    if (tabId === 'single-post') {
                        openPostPopup();
                        togglePanel();
                        return;
                    }

                    const targetTabButton = document.querySelector(`.tab-btn[onclick*="'${tabId}'"]`);
                    if(targetTabButton) {
                        DOMElements.toolkitCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetTabButton.click();
                        togglePanel();
                    }
                });
            });

            document.querySelectorAll('input[name="growth-rate"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (lastProfileStats) {
                        const rate = parseFloat(this.value);
                        renderGrowthProjection(lastProfileStats.stats, rate);
                    }
                });
            });

            const ctaPopupOverlay = document.getElementById('cta-popup-overlay');
            const closeCtaPopup = () => { ctaPopupOverlay.classList.remove('open'); };
            document.getElementById('close-cta-popup-btn').addEventListener('click', closeCtaPopup);
            ctaPopupOverlay.addEventListener('click', (e) => { if (e.target === ctaPopupOverlay) closeCtaPopup(); });
            
            const optimizePopupOverlay = document.getElementById('optimize-popup-overlay');
            document.getElementById('optimize-btn').addEventListener('click', runOptimizationAnalysis);
            document.getElementById('close-optimize-popup-btn').addEventListener('click', () => optimizePopupOverlay.classList.remove('open'));
            document.getElementById('download-optimization-report-btn').addEventListener('click', downloadOptimizationReport);
            
            DOMElements.openWorthPopupBtn.addEventListener('click', openWorthPopup);
            DOMElements.closeWorthPopupBtn.addEventListener('click', closeWorthPopup);
            DOMElements.worthPopupOverlay.addEventListener('click', (e) => { if (e.target === DOMElements.worthPopupOverlay) closeWorthPopup(); });
            
            DOMElements.comparisonPopupOverlay.addEventListener('click', (e) => { if (e.target === DOMElements.comparisonPopupOverlay) DOMElements.comparisonPopupOverlay.classList.remove('open'); });

            document.getElementById('history-prev-btn').addEventListener('click', () => {
                if (historyCurrentPage > 1) {
                    historyCurrentPage--;
                    renderHistory();
                }
            });
            document.getElementById('history-next-btn').addEventListener('click', () => {
                const totalPages = Math.ceil(fullHistory.length / HISTORY_ITEMS_PER_PAGE);
                if (historyCurrentPage < totalPages) {
                    historyCurrentPage++;
                    renderHistory();
                }
            });


            document.getElementById('default-tab').click(); 
            setTimeout(() => fetchProfile(), 500);
            fetchHistory();

            const popupStorageKey = 'ctaPopupLastShown';
            let popupTimer;

            function canShowCtaPopup() {
                const lastShownTimestamp = localStorage.getItem(popupStorageKey);
                if (!lastShownTimestamp) {
                    return true;
                }
                const twentyFourHoursInMillis = 24 * 60 * 60 * 1000;
                const timeSinceLastShown = Date.now() - parseInt(lastShownTimestamp, 10);
                return timeSinceLastShown > twentyFourHoursInMillis;
            }

            function setCtaPopupShown() {
                localStorage.setItem(popupStorageKey, Date.now().toString());
            }

            function triggerCtaPopup() {
                if (ctaPopupOverlay.classList.contains('open') || !canShowCtaPopup()) {
                    return;
                }
                ctaPopupOverlay.classList.add('open');
                setCtaPopupShown();
                clearTimeout(popupTimer);
                document.body.removeEventListener('mouseleave', handleExitIntent);
            }

            function handleExitIntent(e) {
                if (e.clientY <= 0) {
                    triggerCtaPopup();
                }
            }
            
            if (canShowCtaPopup()) {
                popupTimer = setTimeout(triggerCtaPopup, 60000);
                document.body.addEventListener('mouseleave', handleExitIntent);
            }

            // --- Hamburger Menu Logic ---
            const hamburgerBtn = document.getElementById('header-hamburger-btn');
            const hamburgerDropdown = document.getElementById('header-hamburger-dropdown');
            const ctaPopupOverlayForHam = document.getElementById('cta-popup-overlay');

            hamburgerBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent closing immediately
                hamburgerBtn.classList.toggle('active');
                hamburgerDropdown.classList.toggle('active');
            });

            // Handle clicks on menu items
            document.querySelectorAll('.ham-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const action = item.dataset.action;
                    const tabId = item.dataset.tabid;

                    if (action === 'tab') {
                        e.preventDefault();
                        const targetTabButton = document.querySelector(`.tab-btn[onclick*="'${tabId}'"]`);
                        if (targetTabButton) {
                            targetTabButton.click();
                             // Scroll to the toolkit card after a short delay to allow tab to render
                            setTimeout(() => {
                                DOMElements.toolkitCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        }
                    } else if (action === 'popup') {
                        e.preventDefault();
                        if (ctaPopupOverlayForHam) {
                            ctaPopupOverlayForHam.classList.add('open');
                        }
                    }
                    // For all actions, close the dropdown
                    hamburgerBtn.classList.remove('active');
                    hamburgerDropdown.classList.remove('active');
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (hamburgerDropdown.classList.contains('active') && !hamburgerBtn.contains(e.target) && !hamburgerDropdown.contains(e.target)) {
                    hamburgerBtn.classList.remove('active');
                    hamburgerDropdown.classList.remove('active');
                }
            });

            // AI Caption functionality for both main and popup
            document.addEventListener('click', async (e) => {
                if (e.target.id === 'ai-caption-btn' || e.target.id === 'ai-caption-btn-popup') {
                    const aiBtn = e.target;
                    const isPopup = aiBtn.id.includes('popup');
                    const idSuffix = isPopup ? '-popup' : '';

                    // Show loading state
                    const captionContent = document.getElementById(`post-caption-content${idSuffix}`);
                    if (captionContent) {
                        captionContent.innerHTML = '<div class="flex items-center justify-center gap-2 py-4"><span class="text-gray-500">Generating AI caption...</span> <div class="spinner !w-4 !h-4 !border-2"></div></div>';
                    }

                    // Generate AI caption
                    if (lastPostItemStruct) {
                        const caption = lastPostItemStruct.desc || '';
                        const hashtags = lastPostItemStruct.textExtra?.filter(t => t.hashtagName) || [];
                        const mentions = lastPostItemStruct.textExtra?.filter(t => !t.hashtagName) || [];
                        const music = lastPostItemStruct.music;

                        const generatedCaption = await generateAICaptionHTML(caption, hashtags, mentions, music);

                        // Ensure we have valid content
                        if (generatedCaption && generatedCaption.trim()) {
                            aiCaptionHTML = generatedCaption;

                            // Update both main and popup versions
                            const mainCaptionContent = document.getElementById('post-caption-content');
                            if (mainCaptionContent) {
                                mainCaptionContent.innerHTML = aiCaptionHTML;
                            }

                            const popupCaptionContent = document.getElementById('post-caption-content-popup');
                            if (popupCaptionContent) {
                                popupCaptionContent.innerHTML = aiCaptionHTML;
                            }
                        } else {
                            console.error('AI caption generation failed or returned empty content');
                            // Fallback to original caption
                            showOriginalCaption();
                        }
                    }

                    // Hide AI button and show Before/After buttons
                    aiBtn.classList.add('hidden');
                    const captionOptions = aiBtn.nextElementSibling;
                    if (captionOptions) {
                        captionOptions.classList.remove('hidden');
                    }

                } else if (e.target.id === 'before-btn' || e.target.id === 'before-btn-popup') {
                    showOriginalCaption();
                } else if (e.target.id === 'after-btn' || e.target.id === 'after-btn-popup') {
                    showAICaption();
                }
            });
        });
    </script>

</body></html>
